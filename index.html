<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Retirement Calculator</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bitcoin: { 50: '#fffcf2', 100: '#fff7d6', 200: '#ffeeb0', 300: '#ffe080', 400: '#ffd04d', 500: '#f7931a', 600: '#de760b', 700: '#b8580b', 800: '#94440f', 900: '#7a3b12' },
                        gold: { 50: '#fbf8f2', 100: '#f5efe0', 200: '#eaddc2', 300: '#dec498', 400: '#d1a870', 500: '#c2904e', 600: '#a6723e', 700: '#8c5d36', 800: '#754f33', 900: '#61432f' },
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'], serif: ['Playfair Display', 'serif'] },
                }
            }
        }
    </script>
    <script src="js/statistics.js"></script>
    <script src="js/engine.js"></script>
    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Playfair+Display:wght@700&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        h1,
        h2,
        h3 {
            font-family: 'Playfair Display', serif;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #fbf8f2;
        }

        ::-webkit-scrollbar-thumb {
            background: #dec08a;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #b8873b;
        }

        .loading-spinner {
            border: 3px solid #f5efe0;
            border-top: 3px solid #b8873b;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        /* HIDE SCROLLBAR FOR SIDEBAR */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Expansion Panel Animation */
        .advanced-panel {
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }

        .advanced-panel.open {
            max-height: 2000px;
            /* Arbitrary large height */
            opacity: 1;
        }

        /* Tutorial Overlay */
        #tutorial-overlay {
            background: transparent;
            transition: opacity 0.3s;
            position: absolute;
        }

        .tutorial-highlight {
            position: relative;
            z-index: 60 !important;
            box-shadow: 0 0 0 4px #f7931a, 0 0 0 10000px rgba(0, 0, 0, 0.5);
            background-color: transparent;
            border-radius: 8px;
            pointer-events: none;
        }

        /* Tooltip */
        .tutorial-tooltip {
            position: absolute;
            z-index: 70;
            background: #f7931a;
            color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: none;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
            max-width: 440px;
            width: max-content;
            animation: fadeIn 0.3s ease-out;
            pointer-events: auto;
            line-height: 1.6;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tutorial-tooltip::after {
            content: '';
            position: absolute;
            border-style: solid;
            display: block;
        }

        .tutorial-tooltip.tooltip-right::after {
            top: 30px;
            margin-top: -8px;
            left: -8px;
            border-width: 8px 8px 8px 0;
            border-color: transparent #f7931a transparent transparent;
        }

        .tutorial-tooltip.tooltip-bottom::after {
            top: -8px;
            left: 20px;
            border-width: 0 8px 8px 8px;
            border-color: transparent transparent #f7931a transparent;
        }

        .nav-link.active {
            color: #f7931a;
            font-weight: 600;
            border-bottom: 2px solid #f7931a;
        }

        #loading-overlay {
            position: fixed;
            inset: 0;
            background: #f7931a;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.8s ease-in-out, visibility 0.8s;
            color: white;
        }

        #loading-overlay.fade-out {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .loader-spinner {
            width: 80px;
            height: 80px;
            border: 6px solid rgba(255, 255, 255, 0.3);
            border-top: 6px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 2rem;
        }

        .rocket {
            font-size: 2.5rem;
            position: absolute;
            bottom: -50px;
            opacity: 0;
            transition: transform 4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s;
            z-index: 10000;
        }

        .rocket.launch {
            opacity: 1;
            transform: translateY(-120vh) rotate(-10deg);
        }

        .moon {
            position: absolute;
            top: 10%;
            right: 15%;
            width: 150px;
            height: 150px;
            background: url('img/moon.png') no-repeat center center;
            background-size: 135%;
            /* Zoom in to hide checkerboard edges */
            /* box-shadow: 0 0 60px rgba(255, 255, 255, 0.3); Optional subtle glow */
            opacity: 0.9;
            z-index: 1;
            border-radius: 50%;
            /* Clips fake transparent corners if present */
        }

        .btc-logo {
            width: 120px;
            height: 120px;
            z-index: 2;
            filter: drop-shadow(0 0 20px rgba(247, 147, 26, 0.5));
            animation: pulse 2s infinite ease-in-out;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.05);
                opacity: 0.9;
            }
        }

        .loading-text {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: 0.05em;
        }

        /* Scrollbar hiding utility */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Responsive height fixes */
        @media (max-width: 1024px) {
            #view-calculator {
                height: calc(100vh - 160px);
                /* Adjust based on header height */
            }
        }
    </style>
</head>

<body class="bg-gold-50 text-slate-800 min-h-screen flex flex-col">

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="moon"></div>
        <img src="https://upload.wikimedia.org/wikipedia/commons/4/46/Bitcoin.svg" class="btc-logo" alt="Bitcoin Logo">
    </div>

    <!-- Header -->
    <!-- Header -->
    <header
        class="bg-white border-b border-orange-200/30 px-4 sm:px-6 py-4 shadow-sm flex-none z-10 transition-all duration-300">
        <div class="container mx-auto flex flex-col sm:flex-row justify-between items-center gap-4 sm:gap-0">
            <div class="flex items-center gap-3 sm:gap-4">
                <img src="https://upload.wikimedia.org/wikipedia/commons/4/46/Bitcoin.svg" alt="Bitcoin Logo"
                    class="w-8 h-8 sm:w-10 sm:h-10 drop-shadow-sm">
                <h1 class="text-xl sm:text-2xl lg:text-3xl font-bold text-slate-800 tracking-tight">Bitcoin <span
                        class="text-[#F7931A]">Retirement</span> Calculator</h1>
            </div>
            <div id="status-indicator"
                class="bg-gold-50/50 backdrop-blur-sm px-3 py-1 rounded-full text-xs font-mono font-bold border border-gold-100 flex items-center gap-2">
            </div>
        </div>

        <!-- Navigation -->
        <nav
            class="container mx-auto px-4 sm:px-6 pt-4 flex gap-6 sm:gap-8 text-sm sm:text-base text-slate-500 border-t border-orange-100/30 mt-4 font-semibold overflow-x-auto no-scrollbar whitespace-nowrap">
            <button onclick="switchView('calculator')" id="nav-calculator"
                class="nav-link active pb-3 hover:text-[#F7931A] transition">Calculator</button>
            <button onclick="switchView('info')" id="nav-info"
                class="nav-link pb-3 hover:text-[#F7931A] transition">Methodology</button>
            <button onclick="switchView('satoshi')" id="nav-satoshi"
                class="nav-link pb-3 hover:text-[#F7931A] transition">Satoshi Nakamoto</button>
            <div class="flex-1 min-w-[20px] sm:min-w-0"></div>
            <button onclick="startTutorial()"
                class="flex items-center gap-1.5 text-[#F7931A] font-medium pb-3 hover:text-[#de760b] transition shrink-0">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                    </path>
                </svg>
                <span>Take a Tour</span>
            </button>
        </nav>
    </header>

    <div id="view-calculator" class="flex-1 flex flex-col lg:flex-row">

        <!-- Sidebar: Configuration -->
        <aside
            class="w-full lg:w-[420px] flex-none bg-white border-b lg:border-b-0 lg:border-r border-orange-200/30 z-0 shadow-[4px_0_24px_rgba(0,0,0,0.02)]">
            <div class="p-6 space-y-8">

                <!-- Section 1: Portfolio -->
                <div class="space-y-4">
                    <div class="flex items-center gap-2 pb-2 border-b border-orange-100/30">
                        <svg class="w-5 h-5 text-[#F7931A]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                            </path>
                        </svg>
                        <h3 class="text-sm font-bold text-[#F7931A] uppercase tracking-widest">Portfolio Setup</h3>
                    </div>

                    <div class="grid grid-cols-2 gap-x-4 gap-y-6">
                        <!-- Horizon -->
                        <div class="col-span-1">
                            <label
                                class="block text-[10px] font-bold text-[#F7931A] uppercase tracking-widest mb-1.5">Horizon
                                (Years)</label>
                            <input type="number" id="inp-years" value="30"
                                class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-slate-700 font-medium focus:outline-none focus:border-[#F7931A] focus:ring-1 focus:ring-[#F7931A] transition shadow-sm h-[46px]">
                        </div>

                        <!-- Cash Buffer -->
                        <div class="col-span-1">
                            <label
                                class="block text-[10px] font-bold text-[#F7931A] uppercase tracking-widest mb-1.5">Cash
                                Buffer ($)</label>
                            <div class="relative">
                                <span class="absolute left-3.5 top-[11px] text-slate-400 text-sm">$</span>
                                <input type="text" id="inp-buffer" value="0"
                                    class="w-full pl-8 bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-slate-700 font-mono focus:outline-none focus:border-[#F7931A] focus:ring-1 focus:ring-[#F7931A] transition shadow-sm h-[46px]">
                            </div>

                            <div class="flex items-center gap-2.5 mt-2.5 ml-1">
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="chk-refill-buffer" class="sr-only peer" checked>
                                    <div
                                        class="w-7 h-4 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-[#F7931A]">
                                    </div>
                                </label>
                                <label for="chk-refill-buffer"
                                    class="text-[9px] font-black text-[#F7931A] uppercase cursor-pointer select-none tracking-tight">Smart
                                    Refill</label>
                                <div class="relative group">
                                    <svg class="w-2.5 h-2.5 text-slate-300 cursor-help hover:text-[#F7931A] transition-colors"
                                        fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <div
                                        class="absolute bottom-full right-0 mb-2 w-56 p-2.5 bg-[#F7931A] text-white text-[9px] leading-relaxed rounded-xl shadow-2xl hidden group-hover:block z-50 pointer-events-none border border-[#de760b]">
                                        Refills buffer from profits only when Portfolio > 110% initial value.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-6 mt-6">
                        <!-- Invested Amount -->
                        <div>
                            <label
                                class="block text-[10px] font-bold text-[#F7931A] uppercase tracking-widest mb-1.5">Invested
                                Amount ($)</label>
                            <div class="relative">
                                <span class="absolute left-3.5 top-[11px] text-slate-400 text-sm">$</span>
                                <input type="text" id="inp-initial" value="1.500.000"
                                    class="w-full pl-8 bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-slate-700 font-mono focus:outline-none focus:border-[#F7931A] focus:ring-1 focus:ring-[#F7931A] transition shadow-sm h-[46px]">
                            </div>
                        </div>

                        <!-- Total Capital (Streamlined Bar) -->
                        <!-- Total Capital (Standardized Design) -->
                        <div>
                            <label
                                class="block text-[10px] font-bold text-[#F7931A] uppercase tracking-widest mb-1.5">Total
                                Capital (Invested + Cash)</label>
                            <div
                                class="bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 flex items-center justify-end h-[46px] shadow-sm">
                                <span id="disp-total-capital" class="text-sm font-mono font-bold text-slate-800">$
                                    1.500.000</span>
                            </div>
                        </div>

                        <!-- Target Annual Expenses -->
                        <div>
                            <label
                                class="block text-[10px] font-bold text-[#F7931A] uppercase tracking-widest mb-1.5">Target
                                Annual Expenses ($)</label>
                            <div class="relative">
                                <span class="absolute left-3.5 top-[11px] text-slate-400 text-sm">$</span>
                                <input type="text" id="inp-target-annual" value="60.000"
                                    class="w-full pl-8 bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-slate-700 font-mono focus:outline-none focus:border-[#F7931A] transition shadow-sm h-[46px]">
                            </div>
                        </div>
                    </div>

                    <!-- Withdrawal Guardrails (Blue Card Design) -->
                    <div class="bg-orange-50/20 rounded-lg p-3 border border-orange-100/30 mt-2">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-[10px] font-bold text-[#F7931A] uppercase tracking-widest">Withdrawal
                                Guardrails</span>
                            <svg class="w-3 h-3 text-[#F7931A]/40" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>

                        <div class="space-y-3">
                            <div>
                                <label class="block text-[10px] text-slate-500 mb-1">Floor Multiplier</label>
                                <input type="number" id="inp-floor-mult" value="0.0" step="0.1"
                                    class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-slate-700 text-xs">
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-[10px] text-slate-500 mb-1">Ceiling (Y1-10)</label>
                                    <input type="number" id="inp-ceiling-early" value="100.0" step="0.1"
                                        class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-slate-700 text-xs">
                                </div>
                                <div>
                                    <label class="block text-[10px] text-slate-500 mb-1">Ceiling (Y11-50)</label>
                                    <input type="number" id="inp-ceiling-late" value="100.0" step="0.1"
                                        class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-slate-700 text-xs">
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- Sim Settings -->
                    <div class="space-y-4 pt-4 border-t border-orange-100/30">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="col-span-1">
                                <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Sim Data
                                    Points</label>
                                <input type="number" id="inp-num-sims" value="1000"
                                    class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-700 text-sm focus:outline-none focus:border-[#F7931A] transition shadow-sm">
                            </div>
                            <div class="col-span-1">
                                <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Target
                                    Success (%)</label>
                                <input type="number" step="1" id="inp-target-success" value="95"
                                    class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-700 text-sm focus:outline-none focus:border-[#F7931A] transition shadow-sm">
                            </div>
                        </div>
                    </div>

                    <!-- Simulation Button -->
                    <div class="pt-2 pb-6">
                        <button id="btn-run" disabled onclick="runSimulation()"
                            class="w-full bg-[#F7931A] hover:bg-[#de760b] disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-4 px-6 rounded-xl shadow-lg shadow-orange-200 transition transform active:scale-[0.98] flex justify-center items-center gap-3">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z">
                                </path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span>Run Simulation</span>
                        </button>
                    </div>

                    <!-- Asset Allocation -->
                    <div class="space-y-4">
                        <div class="flex items-center gap-2 pb-2 border-b border-orange-100/30">
                            <svg class="w-5 h-5 text-[#F7931A]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path>
                            </svg>
                            <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest">Asset Allocation</h3>
                        </div>

                        <div class="bg-orange-50/30 rounded-xl p-4 border border-orange-100/30 space-y-6">
                            <!-- Bonds Slider -->
                            <div class="pb-2 border-b border-white/50">
                                <div class="flex justify-between text-xs mb-2">
                                    <span class="flex items-center gap-1 font-bold text-slate-700">
                                        <span class="text-[#F7931A]">●</span> Bonds (FI)
                                    </span>
                                    <span id="lbl-bonds-pct" class="font-mono text-[#F7931A] font-bold">50%</span>
                                </div>
                                <input type="range"
                                    class="w-full accent-[#F7931A] h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer hover:bg-slate-300 transition"
                                    min="0" max="100" step="5" id="inp-alloc-bonds-pct" value="50"
                                    oninput="updateAllocations('bonds')">
                                <p class="text-[10px] text-slate-400 mt-1">Fixed income & capital preservation</p>
                            </div>

                            <!-- Stocks Slider -->
                            <div>
                                <div class="flex justify-between text-xs mb-2">
                                    <span class="flex items-center gap-1 font-bold text-slate-700">
                                        <span class="text-[#F7931A]">●</span> Stocks (ETF)
                                    </span>
                                    <span id="lbl-stocks-pct" class="font-mono text-[#F7931A] font-bold">50%</span>
                                </div>
                                <input type="range"
                                    class="w-full accent-[#F7931A] h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer hover:bg-slate-300 transition"
                                    min="0" max="100" step="5" id="inp-alloc-stocks-pct" value="50"
                                    oninput="updateAllocations('stocks')">
                            </div>

                            <!-- Crypto Slider -->
                            <div>
                                <div class="flex justify-between text-xs mb-2">
                                    <span class="flex items-center gap-1 font-bold text-slate-700">
                                        <span class="text-[#F7931A]">●</span> Crypto (BTC)
                                    </span>
                                    <span id="lbl-crypto-pct" class="font-mono text-[#F7931A] font-bold">0%</span>
                                </div>
                                <input type="range"
                                    class="w-full accent-[#F7931A] h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer hover:bg-slate-300 transition"
                                    min="0" max="100" step="5" id="inp-alloc-crypto-pct" value="0"
                                    oninput="updateAllocations('crypto')">
                            </div>
                        </div>
                    </div>

                    <!-- Deep Tweak Section -->
                    <div class="space-y-4">
                        <button onclick="toggleAdvanced()"
                            class="w-full flex items-center justify-between text-xs font-bold text-[#F7931A] uppercase tracking-widest hover:text-[#de760b] transition outline-none">
                            <span>Advanced Market Assumptions</span>
                            <svg id="icon-advanced" class="w-4 h-4 transform transition-transform" fill="none"
                                stroke="#F7931A" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7">
                                </path>
                            </svg>
                        </button>

                        <div id="pnl-advanced" class="advanced-panel space-y-6">

                            <!-- Stress Test Parameters (New) -->
                            <div class="bg-red-50/50 rounded-lg p-3 border border-red-100">
                                <p class="text-[10px] uppercase font-bold text-red-500 mb-2">Stress Test / Bad Years</p>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-[10px] text-slate-500 mb-1">Max Consecutive Bad Years
                                            (Limit)</label>
                                        <input type="number" id="inp-max-bad-years" value="5"
                                            class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-xs">
                                        <p class="text-[9px] text-slate-400 mt-0.5">Limits recovery logic after this
                                            many
                                            down years.</p>
                                    </div>

                                    <div class="flex items-center gap-3 pt-1 border-t border-red-100/50">
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="chk-force-start-crash" class="sr-only peer">
                                            <div
                                                class="w-7 h-4 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-red-500">
                                            </div>
                                        </label>
                                        <label for="chk-force-start-crash"
                                            class="text-[10px] font-bold text-red-600 select-none cursor-pointer">Force
                                            Crash at Start</label>
                                    </div>

                                    <div id="div-crash-config" class="hidden pl-5 space-y-2 border-l-2 border-red-100">
                                        <div>
                                            <label class="block text-[10px] text-slate-500 mb-1">Crash Duration
                                                (Years)</label>
                                            <input type="number" id="inp-crash-duration" value="3"
                                                class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-xs">
                                        </div>
                                        <p class="text-[9px] text-red-400 italic">Forces returns to be negative for the
                                            first N years.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Inflation -->
                            <div class="bg-slate-50 rounded-lg p-3 border border-slate-200">
                                <p class="text-[10px] uppercase font-bold text-slate-400 mb-2">Inflation Parameters</p>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-[10px] text-slate-500 mb-1">Mean Inflation</label>
                                        <input type="number" step="0.001" id="inp-infl-mean" value="0.025"
                                            class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-xs">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] text-slate-500 mb-1">Vol Inflation</label>
                                        <input type="number" step="0.001" id="inp-infl-vol" value="0.015"
                                            class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-xs">
                                    </div>
                                </div>
                            </div>

                            <!-- Correlation -->
                            <div class="bg-slate-50 rounded-lg p-3 border border-slate-200">
                                <p class="text-[10px] uppercase font-bold text-slate-400 mb-2">Asset Correlation</p>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-[10px] text-slate-500 mb-1">Start Correlation</label>
                                        <input type="number" step="0.05" id="inp-corr-start" value="0.40"
                                            class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-xs">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] text-slate-500 mb-1">End Correlation</label>
                                        <input type="number" step="0.05" id="inp-corr-end" value="0.70"
                                            class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-xs">
                                    </div>
                                </div>
                            </div>

                            <!-- Crypto Params -->
                            <div class="bg-orange-50/50 rounded-lg p-3 border border-orange-100">
                                <p class="text-[10px] uppercase font-bold text-orange-400 mb-2">Crypto Assumptions</p>
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <div>
                                        <label class="block text-[10px] text-slate-500 mb-1">CAGR Start</label>
                                        <input type="number" step="0.01" id="inp-c-cagr-start" value="0.32"
                                            class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-xs font-mono text-orange-600">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] text-slate-500 mb-1">CAGR End</label>
                                        <input type="number" step="0.01" id="inp-c-cagr-end" value="0.08"
                                            class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-xs font-mono text-orange-600">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-[10px] text-slate-500 mb-1">Vol Start</label>
                                        <input type="number" step="0.01" id="inp-c-vol-start" value="0.40"
                                            class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-xs font-mono text-orange-600">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] text-slate-500 mb-1">Vol End</label>
                                        <input type="number" step="0.01" id="inp-c-vol-end" value="0.20"
                                            class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-xs font-mono text-orange-600">
                                    </div>
                                </div>
                            </div>

                            <!-- Stock Params -->
                            <div class="bg-blue-50/50 rounded-lg p-3 border border-blue-100">
                                <p class="text-[10px] uppercase font-bold text-blue-400 mb-2">Stock Assumptions</p>
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <div>
                                        <label class="block text-[10px] text-slate-500 mb-1">CAGR Start</label>
                                        <input type="number" step="0.01" id="inp-s-cagr-start" value="0.08"
                                            class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-xs font-mono text-blue-600">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] text-slate-500 mb-1">CAGR End</label>
                                        <input type="number" step="0.01" id="inp-s-cagr-end" value="0.08"
                                            class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-xs font-mono text-blue-600">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="block text-[10px] text-slate-500 mb-1">Vol Start</label>
                                        <input type="number" step="0.01" id="inp-s-vol-start" value="0.16"
                                            class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-xs font-mono text-blue-600">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] text-slate-500 mb-1">Vol End</label>
                                        <input type="number" step="0.01" id="inp-s-vol-end" value="0.16"
                                            class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-xs font-mono text-blue-600">
                                    </div>
                                </div>
                            </div>

                            <!-- Bond Params -->
                            <div class="bg-green-50/50 rounded-lg p-3 border border-green-100">
                                <p class="text-[10px] uppercase font-bold text-green-400 mb-2">Bond Assumptions</p>
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <div>
                                        <label class="block text-[10px] text-slate-500 mb-1">CAGR</label>
                                        <input type="number" step="0.001" id="inp-b-cagr-start" value="0.050"
                                            class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-xs font-mono text-green-600">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] text-slate-500 mb-1">Vol</label>
                                        <input type="number" step="0.01" id="inp-b-vol-start" value="0.05"
                                            class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-xs font-mono text-green-600">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                </div>
        </aside>

        <!-- Main Content: Results -->
        <main id="main-results-panel" class="flex-1 bg-slate-50 p-4 sm:p-6 lg:p-10 relative">

            <!-- Welcome / Empty State -->
            <div id="results-placeholder" class="text-center mt-32 opacity-40">
                <div
                    class="w-24 h-24 bg-white rounded-full mx-auto flex items-center justify-center shadow-sm border border-gold-100 mb-6">
                    <svg class="w-10 h-10 text-gold-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                        </path>
                    </svg>
                </div>
                <h2 class="text-3xl font-serif text-slate-700 mb-2">Ready to Simulate</h2>
                <p class="text-slate-500">Configure your portfolio parameters on the left to begin.</p>
            </div>

            <!-- Results Container (Hidden initially) -->
            <div id="results-container" class="hidden space-y-16 max-w-6xl ml-0 mr-auto animate-fade-in pb-20">

                <!-- SECTION 1: THE VISION (Required For Goal) -->
                <div id="vision-section" class="space-y-6">
                    <div class="flex items-center gap-4">
                        <h2 class="text-xs font-black text-gold-500 uppercase tracking-[0.2em] whitespace-nowrap">The
                            Vision (Required For Target Goal)</h2>
                        <div class="h-px bg-gold-200 flex-1"></div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 lg:gap-8">
                        <!-- Success Probability -->
                        <div
                            class="bg-white rounded-3xl p-8 shadow-sm border border-slate-100 relative overflow-hidden group">
                            <div
                                class="absolute -right-6 -top-6 w-32 h-32 bg-orange-50/50 rounded-full group-hover:scale-110 transition-transform">
                            </div>
                            <p
                                class="text-[10px] font-bold text-[#F7931A] uppercase tracking-widest relative z-10 mb-2">
                                Success Probability</p>
                            <p id="res-success-val"
                                class="text-5xl sm:text-6xl lg:text-7xl font-serif font-bold text-slate-800 text-right relative z-10">
                                --%</p>
                            <div class="w-full bg-slate-100 rounded-full h-2.5 mt-6 relative z-10 overflow-hidden">
                                <div id="res-success-bar"
                                    class="bg-[#F7931A] h-full rounded-full shadow-[0_0_15px_rgba(247,147,26,0.3)] transition-all duration-1000"
                                    style="width: 0%"></div>
                            </div>
                            <p id="txt-success-desc"
                                class="text-[10px] text-slate-400 font-medium mt-5 leading-relaxed">
                                Percentage of
                                scenarios where your capital survived the full term.</p>
                            <p class="text-[10px] text-[#F7931A] font-bold mt-1">Your Planned Withdrawal Rate: <span
                                    id="res-planned-wr">--</span>%</p>
                        </div>

                        <!-- Required Capital -->
                        <!-- Required Capital -->
                        <div
                            class="sm:col-span-2 lg:col-span-2 bg-[#F7931A] rounded-3xl p-6 sm:p-8 shadow-xl relative overflow-hidden group">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/4/46/Bitcoin.svg"
                                alt="Bitcoin Logo"
                                class="absolute -right-8 -top-8 w-64 h-64 opacity-10 rotate-12 group-hover:scale-110 transition-transform duration-1000 pointer-events-none">
                            <div
                                class="flex flex-col md:flex-row md:items-center justify-between h-full relative z-10 gap-8">
                                <div class="space-y-2">
                                    <p class="text-[10px] font-bold text-white/90 uppercase tracking-[0.2em]">Required
                                        Capital (Goal)</p>
                                    <p id="res-required-capital" class="text-6xl font-serif font-bold text-white">--</p>
                                    <p class="text-[10px] text-white/80 font-medium italic">Amount needed to achieve
                                        your target success probability.</p>
                                </div>
                                <div
                                    class="bg-black/20 p-6 rounded-2xl border border-white/10 min-w-[200px] flex flex-col justify-center items-center backdrop-blur-sm shadow-inner">
                                    <p id="lbl-shortfall"
                                        class="text-[13px] text-white font-black uppercase tracking-widest text-center">
                                        GOAL DISTANCE: <span id="res-shortfall-val">$ --</span></p>
                                    <p
                                        class="text-[9px] text-white/70 mt-2 uppercase font-bold text-center tracking-tighter">
                                        Current Funding Gap</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECTION 2: THE REALITY (Possible Today) -->
                <div class="space-y-6 pt-4">
                    <div class="flex items-center gap-4">
                        <h2 class="text-xs font-black text-gold-500 uppercase tracking-[0.2em] whitespace-nowrap">The
                            Reality (Supported by Current Wealth)</h2>
                        <div class="h-px bg-gold-200 flex-1"></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Safe Monthly Range (Colspan 2) -->
                        <div
                            class="md:col-span-2 bg-indigo-50/50 p-8 rounded-3xl border border-indigo-100/60 shadow-sm relative overflow-hidden group">
                            <div
                                class="absolute top-0 right-0 w-48 h-48 bg-indigo-100/40 rounded-full -mr-24 -mt-24 group-hover:scale-110 transition-transform duration-700">
                            </div>

                            <div class="flex items-center justify-between mb-8 relative z-10">
                                <div>
                                    <p class="text-[10px] uppercase font-bold tracking-[0.2em] text-indigo-500 mb-1">
                                        Safe Monthly Budget</p>
                                    <h3 class="text-xl font-serif font-bold text-slate-800">Risk Profile Categories</h3>
                                </div>
                                <span
                                    class="text-[10px] bg-indigo-600 text-white px-4 py-1.5 rounded-full font-bold shadow-sm whitespace-nowrap">Boom
                                    Peak: <span id="res-max-monthly">--</span> $</span>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-10 relative z-10">
                                <div class="space-y-2 border-r border-indigo-200/50 pr-4">
                                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-tight">
                                        Conservative (99%)</p>
                                    <p id="res-safe-99" class="text-3xl font-serif font-bold text-slate-700">-- $</p>
                                    <p class="text-[10px] text-slate-400 font-medium italic">SWR: <span
                                            id="res-swr-99">--</span>% | Ultra-safe</p>
                                </div>
                                <div class="space-y-2 border-r border-indigo-200/50 pr-4">
                                    <p class="text-[10px] text-indigo-600 font-bold uppercase tracking-tight">Your
                                        Target (<span id="res-target-ptr">--</span>%)</p>
                                    <p id="res-safe-monthly"
                                        class="text-4xl font-serif font-bold text-slate-900 leading-tight">-- $</p>
                                    <p class="text-[10px] text-indigo-500 font-bold italic">SWR: <span
                                            id="res-swr-target-label">--</span>% | Recommended</p>
                                </div>
                                <div class="space-y-2">
                                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-tight">Aggressive
                                        (90%)</p>
                                    <p id="res-safe-90" class="text-3xl font-serif font-bold text-slate-700">-- $</p>
                                    <p class="text-[10px] text-slate-400 font-medium italic">SWR: <span
                                            id="res-swr-90">--</span>% | Higher risk</p>
                                </div>
                            </div>

                            <div
                                class="mt-8 pt-5 border-t border-indigo-200/40 flex justify-between items-center relative z-10">
                                <span class="text-[11px] text-slate-400 font-medium">Desired Lifestyle: <span
                                        id="lbl-target-monthly" class="font-bold text-slate-600">--</span> /mo</span>
                                <span class="text-[9px] text-indigo-400 uppercase font-black opacity-40">Capital
                                    Dependent Realization</span>
                            </div>
                        </div>

                        <!-- SWR Efficiency -->
                        <div
                            class="bg-white rounded-3xl p-8 shadow-sm border border-slate-100 flex flex-col justify-between group overflow-hidden relative">
                            <div
                                class="absolute -right-6 -top-6 w-24 h-24 bg-gold-50 rounded-full opacity-60 group-hover:scale-125 transition-transform duration-500">
                            </div>
                            <div>
                                <p
                                    class="text-[10px] font-bold text-gold-600 uppercase tracking-widest relative z-10 mb-2">
                                    Safe Withdrawal Rate</p>
                                <p id="res-swr-val"
                                    class="text-6xl font-serif font-bold text-slate-800 text-right relative z-10">--%
                                </p>
                            </div>
                            <p
                                class="text-[10px] text-slate-400 font-medium mt-4 relative z-10 border-t border-slate-50 pt-4 leading-relaxed">
                                <span class="block font-bold text-slate-600 mb-1">Portfolio Efficiency</span>
                                <span id="res-target-disp-desc" class="italic text-gold-600/70">Optimized for your
                                    survival odds</span>
                            </p>
                        </div>
                    </div>

                    <!-- Row 2: Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Median Outcome -->
                        <div
                            class="bg-white rounded-3xl p-8 shadow-sm border border-slate-100 relative overflow-hidden group flex items-center justify-between">
                            <div
                                class="absolute -right-6 -top-6 w-24 h-24 bg-purple-50 rounded-full opacity-50 group-hover:scale-110 transition-transform">
                            </div>
                            <div class="relative z-10">
                                <p class="text-[10px] font-bold text-purple-500 uppercase tracking-widest mb-1">Median
                                    Projected Wealth</p>
                                <div class="flex items-baseline gap-1">
                                    <p id="res-median-end" class="text-4xl font-serif font-bold text-slate-900">--</p>
                                </div>
                                <p class="text-[9px] text-purple-400 mt-2 font-medium">Outcome in 50% of simulated
                                    futures.</p>
                            </div>
                        </div>

                        <!-- Worst Case -->
                        <div
                            class="bg-white rounded-3xl p-8 shadow-sm border border-slate-100 relative overflow-hidden group flex items-center justify-between">
                            <div
                                class="absolute -right-6 -top-6 w-24 h-24 bg-red-50 rounded-full opacity-50 group-hover:scale-110 transition-transform">
                            </div>
                            <div class="relative z-10">
                                <p class="text-[10px] font-bold text-red-500 uppercase tracking-widest mb-1">1% Worst
                                    Case Margin</p>
                                <div class="flex items-baseline gap-1">
                                    <p id="res-worst-case" class="text-4xl font-serif font-bold text-slate-900">--</p>
                                </div>
                                <p class="text-[9px] text-red-400 mt-2 font-medium">Statistical "Zero Bound" for capital
                                    safety.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Chart -->
                    <div class="bg-white rounded-3xl p-8 shadow-sm border border-slate-100">
                        <div id="plot-area"
                            class="w-full flex justify-center items-center bg-slate-50 rounded-2xl p-4 min-h-[300px]">
                            <span class="text-slate-400 text-sm">Chart will render here...</span>
                        </div>
                    </div>
                </div>

            </div>

        </main>
    </div>

    <!-- VIEW: INFO / METHODOLOGY -->
    <div id="view-info" class="hidden flex-1 overflow-y-auto bg-white p-10 animate-fade-in">
        <div class="max-w-4xl mx-auto space-y-8">
            <h2 class="text-4xl font-serif font-bold text-slate-800 text-right border-b border-gold-200 pb-4">
                Methodology & Glossary</h2>
            <section class="space-y-4">
                <h3 class="text-2xl font-serif text-gold-600">Core Logic: Monte Carlo Simulation</h3>
                <p class="text-slate-600 leading-relaxed">
                    This calculator uses <strong>Monte Carlo Simulation</strong> to generate thousands of possible
                    future market scenarios
                    based on statistical parameters.
                    This allows us to stress-test your portfolio against millions of potential realities, including
                    those worse than history.
                </p>
            </section>
            <section class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-slate-50 p-6 rounded-xl border border-slate-100">
                    <h4 class="font-bold text-slate-700 mb-2">CAGR (Compound Annual Growth Rate)</h4>
                    <p class="text-sm text-slate-500">The mean annual return.</p>
                </div>
                <div class="bg-slate-50 p-6 rounded-xl border border-slate-100">
                    <h4 class="font-bold text-slate-700 mb-2">Volatility (Risk)</h4>
                    <p class="text-sm text-slate-500">Standard deviation of returns. We use a "Skewed Normal"
                        distribution.</p>
                </div>
                <div class="bg-slate-50 p-6 rounded-xl border border-slate-100">
                    <h4 class="font-bold text-slate-700 mb-2">Gaussian Copula (Correlation)</h4>
                    <p class="text-sm text-slate-500">Mathematical method to link the random movements of Stocks and
                        Crypto.</p>
                </div>
                <div class="bg-slate-50 p-6 rounded-xl border border-slate-100">
                    <h4 class="font-bold text-slate-700 mb-2">Safe Withdrawal Rate (SWR)</h4>
                    <p class="text-sm text-slate-500">The percentage of your portfolio you can withdraw annually without
                        depleting it.</p>
                </div>
            </section>
        </div>

        <!-- CALCULATION LOGIC SECTION -->
        <div class="max-w-4xl mx-auto space-y-8 mt-16 pt-16 border-t border-slate-100">
            <h3 class="text-2xl font-serif font-bold text-slate-800">Calculation Logic Explained</h3>

            <div class="bg-slate-900 rounded-xl p-6 overflow-hidden text-sm font-mono text-slate-300">
                <div class="flex items-center gap-2 mb-4 text-green-400 border-b border-slate-700 pb-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                    </svg>
                    <span>Portfolio Simulation Loop (Code Excerpt)</span>
                </div>
                <pre>
<span class="text-purple-400">for</span> (let y = 0; y < years; y++) {
    <span class="text-slate-500">// 1. Determine Spending Limits (Guardrails)</span>
    <span class="text-blue-300">const</span> withdrawal = Math.min(
        Math.max(currentTarget, currentFloor), <span class="text-slate-500">// Floor Protection</span>
        currentCeiling                         <span class="text-slate-500">// Ceiling Cap</span>
    );

    <span class="text-slate-500">// 2. Cash Buffer Protection (Sequence Risk Shield)</span>
    <span class="text-purple-400">if</span> (marketReturn < 0) {
        <span class="text-slate-500">// MARKET DOWN: "Prime Harvesting"</span>
        <span class="text-slate-500">// We spend Cash first to avoid selling depreciated assets.</span>
        cashDraw = Math.min(withdrawal, cash);
    } <span class="text-purple-400">else</span> {
        <span class="text-slate-500">// MARKET UP: Spend from Portfolio Gains</span>
        cashDraw = 0;
    }
}
</pre>
            </div>

            <section class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="p-4 border-l-2 border-gold-400">
                    <h4 class="font-bold text-slate-700">Volatility (The Risk)</h4>
                    <p class="text-sm text-slate-500 mt-2">We use <strong>Skew Normal Distributions</strong> to model
                        "Fat Tails" (Crashes). Standard Bell Curves underestimate how often the market drops -20% or
                        more.</p>
                </div>
                <div class="p-4 border-l-2 border-green-400">
                    <h4 class="font-bold text-slate-700">Cash Buffer (The Shield)</h4>
                    <p class="text-sm text-slate-500 mt-2">When the market is down (Negative Return), the simulation
                        automatically draws from your Cash Buffer instead of selling stocks. This drastically improves
                        survival odds.</p>
                </div>
                <div class="p-4 border-l-2 border-blue-400">
                    <h4 class="font-bold text-slate-700">Guardrails (The Brakes)</h4>
                    <p class="text-sm text-slate-500 mt-2">If inflation spikes, your "Ceiling" prevents you from
                        overspending. If your portfolio crashes, the "Floor" ensures you still have enough for basics.
                    </p>
                </div>
            </section>
        </div>

    </div>

    <!-- VIEW: SATOSHI NAKAMOTO -->
    <div id="view-satoshi" class="hidden flex-1 overflow-y-auto bg-gold-50 p-10 animate-fade-in">
        <article
            class="max-w-3xl mx-auto bg-white shadow-xl shadow-gold-100/50 p-12 rounded-lg border border-gold-100 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-gold-400 to-gold-600"></div>

            <header class="mb-10 text-center">
                <span class="text-xs font-bold tracking-[0.2em] text-gold-600 uppercase">The Origin</span>
                <h1 class="text-5xl font-serif font-bold text-slate-900 mt-4 mb-6">Who is Satoshi Nakamoto?</h1>
            </header>
            <div class="prose prose-slate prose-lg mx-auto text-slate-600 font-serif leading-loose">
                <p>
                    <span class="text-6xl float-left mr-4 mt-[-10px] font-bold text-gold-500">O</span>n October 31,
                    2008, a link to a paper titled
                    <em>"Bitcoin: A Peer-to-Peer Electronic Cash System"</em> was posted to a cryptography mailing list.
                    The author was <strong>Satoshi Nakamoto</strong>.
                </p>
                <p>
                    Satoshi didn't just write code; he architected a solution to the "Double-Spend Problem" without
                    requiring a central authority.
                </p>
                <blockquote
                    class="border-l-4 border-gold-400 pl-6 italic my-8 text-slate-500 bg-gold-50 py-4 pr-4 rounded-r-lg">
                    "The root problem with conventional currency is all the trust that's required to make it work... the
                    history of fiat currencies is full of breaches of that trust."
                </blockquote>
                <p>
                    In 2011, Satoshi sent a final email stating he had "moved on to other things," and vanished.
                </p>
            </div>
            <div class="mt-12 pt-8 border-t border-slate-100 text-center">
                <p class="text-xs text-slate-400 uppercase tracking-widest font-sans">WealthGuard Simulations • Est.
                    2026</p>
            </div>
        </article>
    </div>

    <!-- TUTORIAL OVERLAY -->
    <div id="tutorial-overlay" class="fixed inset-0 hidden z-50 pointer-events-none"></div>

    <!-- NATIVE JS LOGIC -->
    <script>
        // --- VISUALIZATION & UI HELPERS ---
        // Note: The core math is now in 'js/engine.js' and 'js/statistics.js'

        function smoothScrollToTop(element, duration = 300) {
            const start = element.scrollTop;
            if (start <= 0) return;
            const startTime = performance.now();

            function scroll(currentTime) {
                const timeElapsed = currentTime - startTime;
                const progress = Math.min(timeElapsed / duration, 1);

                // Ease out cubic
                const ease = 1 - Math.pow(1 - progress, 3);

                element.scrollTop = start * (1 - ease);

                if (progress < 1) {
                    requestAnimationFrame(scroll);
                } else {
                    element.scrollTop = 0; // Ensure exact 0
                }
            }
            requestAnimationFrame(scroll);
        }

        function renderHistogram(data, targetDivId) {
            const div = document.getElementById(targetDivId);
            div.innerHTML = '<canvas id="hist-canvas" class="w-full h-[300px]"></canvas>';
            const canvas = document.getElementById('hist-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;

            const filteredData = data.filter(w => w < 100_000_000).map(w => w / 1e6);
            if (filteredData.length === 0) return;

            const min = 0;
            const max = Math.max(...filteredData);
            const bins = 50;
            const counts = new Array(bins).fill(0);
            filteredData.forEach(val => {
                let b = Math.floor(((val - min) / (max - min)) * bins);
                if (b >= bins) b = bins - 1;
                counts[b]++;
            });

            const maxCount = Math.max(...counts);
            const padding = 40;
            const chartW = canvas.width - 2 * padding;
            const chartH = canvas.height - 2 * padding;

            ctx.strokeStyle = '#e2e8f0'; ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                let y = padding + chartH - (i / 5) * chartH;
                ctx.beginPath(); ctx.moveTo(padding, y); ctx.lineTo(padding + chartW, y); ctx.stroke();
            }

            const barW = chartW / bins;
            ctx.fillStyle = '#f7931a';
            ctx.globalAlpha = 0.8;
            counts.forEach((c, i) => {
                const h = (c / maxCount) * chartH;
                ctx.fillRect(padding + i * barW, padding + chartH - h, barW - 1, h);
            });

            ctx.globalAlpha = 1.0; ctx.fillStyle = '#64748b';
            ctx.font = '10px Inter'; ctx.textAlign = 'center';
            for (let i = 0; i <= 5; i++) {
                const val = (min + (max - min) * (i / 5)).toFixed(1);
                ctx.fillText(val + "M", padding + (i / 5) * chartW, canvas.height - 20);
            }
            ctx.fillText("Wealth Distribution (Million $)", canvas.width / 2, canvas.height - 5);
        }

        const statusEl = document.getElementById("status-indicator");
        const btnRun = document.getElementById("btn-run");
        window.update_status = function (msg, colorClass) {
            // Status messages removed per user request
            // statusEl.innerHTML = `<span class="${colorClass}">${msg}</span>`;
        }

        function parseFormattedValue(val) {
            if (typeof val !== 'string') return val;
            // Handle dots as separators
            return parseFloat(val.replace(/\./g, '')) || 0;
        }

        function formatNumberWithDots(val) {
            let num = val.toString().replace(/\D/g, '');
            if (num === "") return "";
            return parseInt(num).toLocaleString('de-DE');
        }

        function handleCurrencyInput(e) {
            const el = e.target;
            let cursor = el.selectionStart;
            let oldLen = el.value.length;

            el.value = formatNumberWithDots(el.value);

            let newLen = el.value.length;
            el.setSelectionRange(cursor + (newLen - oldLen), cursor + (newLen - oldLen));

            updateTotalCapital();
        }

        function updateTotalCapital() {
            const invested = parseFormattedValue(document.getElementById('inp-initial').value);
            const buffer = parseFormattedValue(document.getElementById('inp-buffer').value);
            const total = invested + buffer;
            document.getElementById('disp-total-capital').innerText = "$ " + total.toLocaleString('de-DE');
        }

        // Attach listeners
        document.getElementById('inp-initial').addEventListener('input', handleCurrencyInput);
        document.getElementById('inp-buffer').addEventListener('input', handleCurrencyInput);
        document.getElementById('inp-target-annual').addEventListener('input', handleCurrencyInput);

        function updateAllocations(source) {
            const cryptoEl = document.getElementById('inp-alloc-crypto-pct');
            const stocksEl = document.getElementById('inp-alloc-stocks-pct');
            const bondsEl = document.getElementById('inp-alloc-bonds-pct');

            let cVal = parseInt(cryptoEl.value) || 0;
            let sVal = parseInt(stocksEl.value) || 0;
            let bVal = parseInt(bondsEl.value) || 0;

            const total = cVal + sVal + bVal;

            if (total !== 100) {
                const diff = total - 100;
                // Distribute the difference to the OTHER two sliders
                if (source === 'stocks') {
                    // Adjust Bonds first, then Crypto
                    if (diff > 0) {
                        let toTake = Math.min(bVal, diff);
                        bVal -= toTake;
                        cVal -= (diff - toTake);
                    } else {
                        bVal -= diff; // diff is negative
                    }
                } else if (source === 'crypto') {
                    if (diff > 0) {
                        let toTake = Math.min(sVal, diff);
                        sVal -= toTake;
                        bVal -= (diff - toTake);
                    } else {
                        sVal -= diff;
                    }
                } else if (source === 'bonds') {
                    if (diff > 0) {
                        let toTake = Math.min(sVal, diff);
                        sVal -= toTake;
                        cVal -= (diff - toTake);
                    } else {
                        sVal -= diff;
                    }
                }
            }

            // Clamping
            cVal = Math.max(0, Math.min(100, cVal));
            sVal = Math.max(0, Math.min(100, sVal));
            bVal = 100 - cVal - sVal; // Ensure exact 100

            cryptoEl.value = cVal;
            stocksEl.value = sVal;
            bondsEl.value = bVal;

            document.getElementById('lbl-crypto-pct').innerText = cVal + "%";
            document.getElementById('lbl-stocks-pct').innerText = sVal + "%";
            document.getElementById('lbl-bonds-pct').innerText = bVal + "%";

            // Visual feedback if bonds are low
            const labelBonds = document.getElementById('lbl-bonds-pct');
            labelBonds.className = bVal < 20 ? "font-mono font-bold text-red-500" : "font-mono font-bold text-green-600";
        }

        function toggleAdvanced() {
            const panel = document.getElementById('pnl-advanced');
            const icon = document.getElementById('icon-advanced');
            panel.classList.toggle('open');
            icon.style.transform = panel.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0deg)';
        }

        document.getElementById('chk-force-start-crash').addEventListener('change', (e) => {
            document.getElementById('div-crash-config').classList.toggle('hidden', !e.target.checked);
        });

        async function runSimulation() {
            btnRun.disabled = true;
            btnRun.innerHTML = '<div class="loading-spinner"></div><span>Simulating...</span>';

            // Allow UI to update
            await new Promise(r => setTimeout(r, 50));

            try {
                const configs = {
                    years: parseInt(document.getElementById("inp-years").value),
                    numSims: parseInt(document.getElementById("inp-num-sims").value),
                    INVESTED_AMOUNT: parseFormattedValue(document.getElementById("inp-initial").value),
                    CASH_BUFFER: parseFormattedValue(document.getElementById("inp-buffer").value),
                    ALLOC_CRYPTO: parseFloat(document.getElementById("inp-alloc-crypto-pct").value) / 100,
                    ALLOC_STOCKS: parseFloat(document.getElementById("inp-alloc-stocks-pct").value) / 100,
                    INFL_MEAN: parseFloat(document.getElementById("inp-infl-mean").value),
                    INFL_VOL: parseFloat(document.getElementById("inp-infl-vol").value),
                    CORR_START: parseFloat(document.getElementById("inp-corr-start").value),
                    CORR_END: parseFloat(document.getElementById("inp-corr-end").value),
                    C_CAGR_START: parseFloat(document.getElementById("inp-c-cagr-start").value),
                    C_CAGR_END: parseFloat(document.getElementById("inp-c-cagr-end").value),
                    C_VOL_START: parseFloat(document.getElementById("inp-c-vol-start").value),
                    C_VOL_END: parseFloat(document.getElementById("inp-c-vol-end").value),
                    S_CAGR_START: parseFloat(document.getElementById("inp-s-cagr-start").value),
                    S_CAGR_END: parseFloat(document.getElementById("inp-s-cagr-end").value),
                    S_VOL_START: parseFloat(document.getElementById("inp-s-vol-start").value),
                    S_VOL_END: parseFloat(document.getElementById("inp-s-vol-end").value),
                    B_CAGR_START: parseFloat(document.getElementById("inp-b-cagr-start").value),
                    B_VOL_START: parseFloat(document.getElementById("inp-b-vol-start").value),
                    FORCE_CRASH: document.getElementById("chk-force-start-crash").checked,
                    CRASH_DURATION: parseInt(document.getElementById("inp-crash-duration").value),
                    TARGET_ANNUAL_EXP: parseFormattedValue(document.getElementById("inp-target-annual").value),
                    REFILL_CASH_BUFFER: document.getElementById("chk-refill-buffer").checked,
                    FLOOR_MULT: parseFloat(document.getElementById("inp-floor-mult").value),
                    CEILING_EARLY: parseFloat(document.getElementById("inp-ceiling-early").value),
                    CEILING_LATE: parseFloat(document.getElementById("inp-ceiling-late").value),
                    CEILING_LATE: parseFloat(document.getElementById("inp-ceiling-late").value),
                    targetSuccess: (() => {
                        let valStr = document.getElementById("inp-target-success").value.replace(',', '.');
                        let val = parseFloat(valStr);
                        // If user enters "95", treat as 95%. If "0.95", treat as 95%.
                        // Threshold: if > 1, assume percentage (divide by 100).
                        if (val > 1) val /= 100;
                        return val || 0.95; // Default strict 95%
                    })()
                };

                // --- DEBUG: LOG PARAMETERS ---
                console.clear();
                console.group("🚀 Simulation Results & Parameters");
                console.table({
                    "Invested Capital": { Value: configs.INVESTED_AMOUNT.toLocaleString() + " $" },
                    "Cash Buffer": { Value: configs.CASH_BUFFER.toLocaleString() + " $" },
                    "Total Capital": { Value: (configs.INVESTED_AMOUNT + configs.CASH_BUFFER).toLocaleString() + " $" },
                    "Horizon": { Value: configs.years + " Years" },
                    "Target Spend": { Value: configs.TARGET_ANNUAL_EXP.toLocaleString() + " $" },
                    "Success Target": { Value: (configs.targetSuccess * 100) + "%" }
                });
                console.table({
                    "Stocks Allocation": { Value: (configs.ALLOC_STOCKS || 0) * 100 + "%" },
                    "Crypto Allocation": { Value: (configs.ALLOC_CRYPTO || 0) * 100 + "%" },
                    "Bonds Allocation": { Value: (100 - (configs.ALLOC_STOCKS || 0) * 100 - (configs.ALLOC_CRYPTO || 0) * 100) + "%" }
                });
                console.table({
                    "Stock Return (Nom)": { Value: (configs.S_CAGR_START * 100).toFixed(1) + "%" },
                    "Stock Volatility": { Value: (configs.S_VOL_START * 100).toFixed(1) + "%" },
                    "Bond Return (Nom)": { Value: (configs.B_CAGR_START * 100).toFixed(1) + "%" },
                    "Bond Volatility": { Value: (configs.B_VOL_START * 100).toFixed(1) + "%" }
                });
                console.groupEnd();
                // -----------------------------

                update_status(`Simulating ${configs.numSims} Scenarios...`, "text-gold-600");
                const marketData = generateMarketData(configs.numSims, configs.years, configs);

                update_status("Calculating Risk Profiles...", "text-purple-500");

                // Scale Buffer for the 1M normalized simulation
                // If user has 1.44M Inv + 60k Cash (Ratio 0.0416), 
                // shConfigs (1M Inv) should have ~41.6k Cash.
                const bufferRatio = configs.INVESTED_AMOUNT > 0 ? configs.CASH_BUFFER / configs.INVESTED_AMOUNT : 0;
                const shInvested = 1000000;
                const shBuffer = shInvested * bufferRatio;

                const shConfigs = { ...configs, INVESTED_AMOUNT: shInvested, CASH_BUFFER: shBuffer, TARGET_ANNUAL_EXP: 0 };

                const findSWR = (targetOdds) => {
                    let low = 0.001, high = 0.20, best = 0.001;
                    for (let i = 0; i < 15; i++) {
                        let mid = (low + high) / 2;
                        let res = simulatePortfolio(mid, marketData, shConfigs);
                        console.log(`SWR Search: Rate ${(mid * 100).toFixed(2)}% -> Success ${(res.successRate * 100).toFixed(1)}%`);
                        if (res.successRate >= targetOdds) { best = mid; low = mid; }
                        else { high = mid; }
                    }
                    return best;
                };

                const bestSWR = findSWR(configs.targetSuccess);
                const swr99 = findSWR(0.99);
                const swr90 = findSWR(0.90);

                update_status("Final Verification...", "text-indigo-500");
                // Final run
                const final = simulatePortfolio(-1, marketData, configs); // -1 withdrawal uses TargetAnnual

                // SWR Display Logic:
                // findSWR returns rate relative to INVESTED_AMOUNT.
                // We want to display SWR relative to TOTAL CAPITAL (User's Net Worth).
                // Safe Annual = bestSWR * INVESTED_AMOUNT.
                // Display Rate = Safe Annual / (INVESTED + CASH).

                const totalCapital = configs.INVESTED_AMOUNT + configs.CASH_BUFFER;
                const displaySWR = (bestSWR * configs.INVESTED_AMOUNT) / totalCapital;
                const displaySWR99 = (swr99 * configs.INVESTED_AMOUNT) / totalCapital;
                const displaySWR90 = (swr90 * configs.INVESTED_AMOUNT) / totalCapital;

                document.getElementById("res-swr-val").innerText = (displaySWR * 100).toFixed(2) + "%";
                document.getElementById("res-swr-99").innerText = (displaySWR99 * 100).toFixed(2);
                document.getElementById("res-swr-90").innerText = (displaySWR90 * 100).toFixed(2);
                document.getElementById("res-swr-target-label").innerText = (displaySWR * 100).toFixed(2);

                document.getElementById("res-success-val").innerText = (final.successRate * 100).toFixed(1) + "%";
                const successBar = document.getElementById("res-success-bar");
                const successPct = final.successRate * 100;
                const targetPct = configs.targetSuccess * 100;

                // Color Logic: Red if < Target, Orange if >= Target (or close)
                // Using "nearly" as effectively meeting the threshold for visual comfort, or just sticking to target.
                // We will use 98% of target as "nearly" threshold if needed, but strict target is clearer.
                // User said: "red until it reaches... orange when it reaches... nearly"
                // Let's make it Red below (Target - 2%), and Orange if >= (Target - 2%)?
                // Or simpler: Red if < Target. Orange if >= Target.

                // Let's try: Red if < Target, Orange if >= Target.
                // Actually user said "orange when it reaches the success rate nearly". 
                // Let's assume a small tolerance of 2%.

                if (successPct < (targetPct - 0.1)) {
                    successBar.classList.remove("bg-[#F7931A]");
                    successBar.classList.add("bg-red-500");
                    successBar.style.boxShadow = "0 0 15px rgba(239, 68, 68, 0.4)"; // Red glow
                } else {
                    successBar.classList.remove("bg-red-500");
                    successBar.classList.add("bg-[#F7931A]");
                    successBar.style.boxShadow = "0 0 15px rgba(247, 147, 26, 0.4)"; // Orange glow
                }
                successBar.style.width = successPct + "%";

                // Dynamic Text Description
                const investedFmt = configs.INVESTED_AMOUNT.toLocaleString('de-DE');
                const bufferFmt = configs.CASH_BUFFER.toLocaleString('de-DE');
                const spendFmt = configs.TARGET_ANNUAL_EXP.toLocaleString('de-DE');
                document.getElementById("txt-success-desc").innerHTML =
                    `Percentage of scenarios where your capital (<strong>$ ${investedFmt}</strong> invested + <strong>$ ${bufferFmt}</strong> cash buffer) survived the full term with <strong>$ ${spendFmt}</strong> annual spending.`;

                const plannedWR = configs.TARGET_ANNUAL_EXP / totalCapital;
                document.getElementById("res-planned-wr").innerText = (plannedWR * 100).toFixed(2);

                // Advanced UI Fields
                document.getElementById("res-target-disp-desc").innerText = `Optimized for ${(configs.targetSuccess * 100).toFixed(0)}% survival odds`;
                document.getElementById("res-target-ptr").innerText = (configs.targetSuccess * 100).toFixed(0);

                const wealths = final.wealths.sort((a, b) => a - b);
                const median = wealths[Math.floor(wealths.length / 2)];
                const worst1 = wealths[Math.floor(wealths.length * 0.01)];

                document.getElementById("res-median-end").innerText = "$ " + Math.round(median).toLocaleString('de-DE');
                document.getElementById("res-worst-case").innerText = "$ " + Math.round(worst1).toLocaleString('de-DE');

                // User requested 'Required Capital' to represent TOTAL Capital (Invested + Cash)
                // We use displaySWR which is the Safe Rate against Total Wealth.
                const reqCap = displaySWR > 0 ? configs.TARGET_ANNUAL_EXP / displaySWR : 0;
                const initialTotal = configs.INVESTED_AMOUNT + configs.CASH_BUFFER;
                const shortfall = Math.max(0, reqCap - initialTotal);

                document.getElementById("res-required-capital").innerText = "$ " + Math.round(reqCap).toLocaleString('de-DE');

                const goalText = shortfall <= 0 ? "Goal Reached" : `Goal distance: $ ${Math.round(shortfall).toLocaleString('de-DE')}`;
                document.getElementById("lbl-shortfall").innerText = goalText;

                // Monthly Reality
                const targetMonthly = configs.TARGET_ANNUAL_EXP / 12;
                const safeMonthly = (initialTotal * bestSWR) / 12;
                const m99 = (initialTotal * swr99) / 12;
                const m90 = (initialTotal * swr90) / 12;
                let peakMonthly = targetMonthly * configs.CEILING_LATE;
                if (targetMonthly === 0) peakMonthly = safeMonthly;

                document.getElementById("res-safe-monthly").innerText = safeMonthly.toLocaleString('de-DE', { maximumFractionDigits: 0 }) + " $";
                document.getElementById("res-safe-99").innerText = m99.toLocaleString('de-DE', { maximumFractionDigits: 0 }) + " $";
                document.getElementById("res-safe-90").innerText = m90.toLocaleString('de-DE', { maximumFractionDigits: 0 }) + " $";
                document.getElementById("res-max-monthly").innerText = peakMonthly.toLocaleString('de-DE', { maximumFractionDigits: 0 });
                document.getElementById("lbl-target-monthly").innerText = targetMonthly.toLocaleString('de-DE', { maximumFractionDigits: 0 }) + " $";

                // --- SINGLE LINE DEBUG OUTPUT ---
                const allocStr = `S:${((configs.ALLOC_STOCKS || 0) * 100).toFixed(0)}/B:${(100 - (configs.ALLOC_STOCKS || 0) * 100 - (configs.ALLOC_CRYPTO || 0) * 100).toFixed(0)}/C:${((configs.ALLOC_CRYPTO || 0) * 100).toFixed(0)}`;
                const retStr = `Ret:S${(configs.S_CAGR_START * 100).toFixed(1)}/B${(configs.B_CAGR_START * 100).toFixed(1)}`;
                const volStr = `Vol:S${(configs.S_VOL_START * 100).toFixed(1)}/B${(configs.B_VOL_START * 100).toFixed(1)}`;
                const infStr = `Inf:${(configs.INFL_MEAN * 100).toFixed(1)}(v${(configs.INFL_VOL * 100).toFixed(1)})`;

                const safeSpd = displaySWR * (configs.INVESTED_AMOUNT + configs.CASH_BUFFER);
                const resStr = `[SIM_FULL] Yrs:${configs.years} | Cap:${(configs.INVESTED_AMOUNT / 1000).toFixed(0)}k+${(configs.CASH_BUFFER / 1000).toFixed(0)}k | Spend:${(configs.TARGET_ANNUAL_EXP / 1000).toFixed(1)}k | ${allocStr} | ${retStr} | ${volStr} | ${infStr} | Tgt:${(configs.targetSuccess * 100).toFixed(0)}% => Succ:${(final.successRate * 100).toFixed(1)}% | SWR:${(displaySWR * 100).toFixed(2)}% (SafeSpd: ${Math.round(safeSpd / 1000)}k)`;
                console.log(resStr);

                // Diagnostic: Check 4% Rule specifically
                const bench4 = simulatePortfolio(0.04, marketData, shConfigs);
                console.log(`[BENCHMARK] Success Rate at 4.0% Withdrawal: ${(bench4.successRate * 100).toFixed(1)}% (Target: ${(configs.targetSuccess * 100).toFixed(0)}%)`);
                // --------------------------------

                document.getElementById("results-placeholder").classList.add("hidden");
                document.getElementById("results-container").classList.remove("hidden");

                renderHistogram(final.wealths, "plot-area");

                // Mobile Auto-Scroll
                if (window.innerWidth < 1024) {
                    setTimeout(() => {
                        const visionSection = document.getElementById("vision-section");
                        if (visionSection) {
                            visionSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }, 100);
                } else {
                    // Desktop: Window Smooth Scroll
                    // We want the whole page to scroll to the top
                    setTimeout(() => {
                        // Use our custom smooth scroll helper on document.documentElement (html) or body
                        // To be safe, we can just use window.scrollTo with behavior
                        const scrollTarget = document.documentElement.scrollTop > 0 ? document.documentElement : document.body;
                        smoothScrollToTop(scrollTarget, 500);
                    }, 150);
                }

            } catch (e) {
                console.error(e);
                alert("Error: " + e.message);
            } finally {
                btnRun.disabled = false;
                btnRun.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span>Run Simulation</span>`;
            }
        }


        // --- NAVIGATION LOGIC ---
        function switchView(viewName) {
            ['calculator', 'info', 'satoshi'].forEach(v => {
                const el = document.getElementById('view-' + v);
                const nav = document.getElementById('nav-' + v);
                if (el) el.classList.add('hidden');
                if (nav) nav.classList.remove('active', 'text-gold-600');
            });

            const targetEl = document.getElementById('view-' + viewName);
            const targetNav = document.getElementById('nav-' + viewName);
            if (targetEl) targetEl.classList.remove('hidden');
            if (targetNav) targetNav.classList.add('active', 'text-gold-600');
        }

        // --- TUTORIAL LOGIC ---
        const tutorialSteps = [
            { id: 'inp-years', title: 'Time Horizon', text: 'How long do you want to plan for?' },
            { id: 'inp-initial', title: 'Invested Capital', text: 'Your current starting portfolio value.' },
            { id: 'inp-buffer', title: 'Cash Buffer', text: 'Cash set aside for emergencies.' },
            { id: 'inp-alloc-crypto-pct', title: 'Asset Allocation', text: 'Balance between Crypto and Stocks.' },
            { id: 'btn-run', title: 'Run Simulation', text: 'Starts the JS Monte Carlo engine.' }
        ];

        let currentStepIndex = -1;

        function startTutorial() {
            switchView('calculator');
            currentStepIndex = 0;
            const ov = document.getElementById('tutorial-overlay');
            ov.classList.remove('hidden', 'pointer-events-none');
            showTutorialStep();
        }

        function endTutorial() {
            currentStepIndex = -1;
            const ov = document.getElementById('tutorial-overlay');
            ov.classList.add('hidden', 'pointer-events-none');
            ov.innerHTML = '';
        }

        function showTutorialStep() {
            const step = tutorialSteps[currentStepIndex];
            const el = document.getElementById(step.targetOverride || step.id);
            if (!el) { endTutorial(); return; }

            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            const rect = el.getBoundingClientRect();

            // Simple positioning
            let top = rect.bottom + window.scrollY + 12;
            let left = rect.left + window.scrollX;

            const tooltipHtml = `
            <div class="tutorial-tooltip tooltip-bottom" style="top: ${top}px; left: ${left}px;">
                <div class="flex justify-between items-start mb-2 border-b border-white/20 pb-2">
                    <h4 class="font-bold text-white text-sm">${step.title}</h4>
                </div>
                <p class="text-sm text-white/90 mb-4">${step.text}</p>
                <div class="flex gap-2">
                    <button onclick="endTutorial()" class="text-xs text-white/60 hover:text-white">Skip</button>
                    <button onclick="nextStep()" class="bg-white/20 text-white text-xs font-bold px-4 py-1.5 rounded">Next</button>
                </div>
            </div>`;
            document.getElementById('tutorial-overlay').innerHTML = tooltipHtml;
        }

        function nextStep() {
            currentStepIndex++;
            if (currentStepIndex >= tutorialSteps.length) endTutorial();
            else showTutorialStep();
        }

        // Initialize logic
        (function main() {
            // update_status("Engine Ready", "text-gold-700");
            const btn = document.getElementById("btn-run");
            if (btn) btn.disabled = false;

            const overlay = document.getElementById('loading-overlay');
            const spinner = document.getElementById('main-spinner');

            // Create 21 rockets
            for (let i = 0; i < 21; i++) {
                const rocket = document.createElement('div');
                rocket.className = 'rocket';
                rocket.innerText = '🚀';
                rocket.style.left = Math.random() * 90 + 5 + '%';
                // Randomize speed slightly for variety but keep it "slower" (around 4s from CSS)
                const delay = i * 150 + Math.random() * 200;
                overlay.appendChild(rocket);

                setTimeout(() => {
                    rocket.classList.add('launch');
                }, delay);
            }

            // Make the load up snappier (2 seconds total)
            setTimeout(() => {
                if (overlay) overlay.classList.add('fade-out');
            }, 2000);
            // Force scroll reset on load
            function resetAllScrolls() {
                window.scrollTo(0, 0);
                const viewCalc = document.getElementById("view-calculator");
                const mainPanel = document.getElementById("main-results-panel");
                const aside = document.querySelector("#view-calculator aside");

                if (viewCalc) viewCalc.scrollTop = 0;
                if (mainPanel) mainPanel.scrollTop = 0;
                if (aside) aside.scrollTop = 0;
            }

            // Execute immediately and after simple delays to fight browser restoration
            if ('scrollRestoration' in history) {
                history.scrollRestoration = 'manual';
            }
            resetAllScrolls();
            setTimeout(resetAllScrolls, 100);
            setTimeout(resetAllScrolls, 500);
        })();

    </script>

</body>

</html>