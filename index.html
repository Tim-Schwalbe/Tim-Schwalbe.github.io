<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WealthGuard Simulator</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bitcoin: { 50: '#fffcf2', 100: '#fff7d6', 200: '#ffeeb0', 300: '#ffe080', 400: '#ffd04d', 500: '#f7931a', 600: '#de760b', 700: '#b8580b', 800: '#94440f', 900: '#7a3b12' },
                        gold: { 50: '#fbf8f2', 100: '#f5efe0', 200: '#eaddc2', 300: '#dec498', 400: '#d1a870', 500: '#c2904e', 600: '#a6723e', 700: '#8c5d36', 800: '#754f33', 900: '#61432f' },
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'], serif: ['Playfair Display', 'serif'] },
                }
            }
        }
    </script>
    <script src="js/statistics.js"></script>
    <script src="js/engine.js"></script>
    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Playfair+Display:wght@700&display=swap"
        rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        h1,
        h2,
        h3 {
            font-family: 'Playfair Display', serif;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #fbf8f2;
        }

        ::-webkit-scrollbar-thumb {
            background: #dec08a;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #b8873b;
        }

        .loading-spinner {
            border: 3px solid #f5efe0;
            border-top: 3px solid #b8873b;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        /* HIDE SCROLLBAR FOR SIDEBAR */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Expansion Panel Animation */
        .advanced-panel {
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }

        .advanced-panel.open {
            max-height: 2000px;
            /* Arbitrary large height */
            opacity: 1;
        }

        /* Tutorial Overlay */
        #tutorial-overlay {
            background: transparent;
            transition: opacity 0.3s;
            position: absolute;
        }

        .tutorial-highlight {
            position: relative;
            z-index: 60 !important;
            box-shadow: 0 0 0 4px #f7931a, 0 0 0 10000px rgba(0, 0, 0, 0.5);
            background-color: transparent;
            border-radius: 8px;
            pointer-events: none;
        }

        /* Tooltip */
        .tutorial-tooltip {
            position: absolute;
            z-index: 70;
            background: #f7931a;
            color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: none;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
            max-width: 440px;
            width: max-content;
            animation: fadeIn 0.3s ease-out;
            pointer-events: auto;
            line-height: 1.6;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tutorial-tooltip::after {
            content: '';
            position: absolute;
            border-style: solid;
            display: block;
        }

        .tutorial-tooltip.tooltip-right::after {
            top: 30px;
            margin-top: -8px;
            left: -8px;
            border-width: 8px 8px 8px 0;
            border-color: transparent #f7931a transparent transparent;
        }

        .tutorial-tooltip.tooltip-bottom::after {
            top: -8px;
            left: 20px;
            border-width: 0 8px 8px 8px;
            border-color: transparent transparent #f7931a transparent;
        }

        .nav-link.active {
            color: #f7931a;
            font-weight: 600;
            border-bottom: 2px solid #f7931a;
        }

        #loading-overlay {
            position: fixed;
            inset: 0;
            background: #f7931a;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.8s ease-in-out, visibility 0.8s;
            color: white;
        }

        #loading-overlay.fade-out {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .loader-spinner {
            width: 80px;
            height: 80px;
            border: 6px solid rgba(255, 255, 255, 0.3);
            border-top: 6px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 2rem;
        }

        #rocket-anim {
            font-size: 4rem;
            position: absolute;
            transition: transform 1s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s;
            opacity: 0;
            transform: translateY(100px);
        }

        #rocket-anim.launch {
            opacity: 1;
            transform: translateY(-200vh);
        }

        .loading-text {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: 0.05em;
        }
    </style>
</head>

<body class="bg-gold-50 text-slate-800 min-h-screen flex flex-col">

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="loader-spinner" id="main-spinner"></div>
        <div id="rocket-anim">üöÄ</div>
        <div class="loading-text" id="main-loading-text">Initializing WealthGuard Engine...</div>
        <div class="mt-4 text-white/70 text-sm font-medium">Connecting Javascript Engine...</div>
    </div>

    <!-- Header -->
    <header class="bg-white border-b border-gold-200 px-6 py-4 shadow-sm flex-none z-10">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div
                    class="w-8 h-8 bg-gold-500 rounded-full flex items-center justify-center text-white font-serif font-bold text-lg shadow-md">
                    S</div>
                <h1 class="text-2xl font-bold text-slate-800 tracking-tight">Wealth<span
                        class="text-gold-500">Guard</span> Simulator</h1>
            </div>
            <div id="status-indicator"
                class="flex items-center gap-2 text-sm text-gold-600 bg-gold-100 px-3 py-1.5 rounded-full border border-gold-200">
                <div class="loading-spinner"></div>
                <span class="font-medium">Initializing Engine...</span>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="container mx-auto px-6 pt-4 flex gap-8 text-sm text-slate-500 border-t border-gold-50 mt-4">
            <button onclick="switchView('calculator')" id="nav-calculator"
                class="nav-link active pb-3 hover:text-gold-600 transition">Calculator</button>
            <button onclick="switchView('info')" id="nav-info"
                class="nav-link pb-3 hover:text-gold-600 transition">Methodology</button>
            <button onclick="switchView('satoshi')" id="nav-satoshi"
                class="nav-link pb-3 hover:text-gold-600 transition">Satoshi Nakamoto</button>
            <div class="flex-1"></div>
            <button onclick="startTutorial()"
                class="flex items-center gap-1.5 text-gold-600 font-medium pb-3 hover:text-gold-700 transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                    </path>
                </svg>
                <span>Take a Tour</span>
            </button>
        </nav>
    </header>

    <div id="view-calculator" class="flex-1 flex">

        <!-- Sidebar: Configuration -->
        <aside class="w-[420px] flex-none bg-white border-r border-gold-200 z-0 shadow-[4px_0_24px_rgba(0,0,0,0.02)]">
            <div class="p-6 space-y-8">

                <!-- Section 1: Portfolio -->
                <div class="space-y-4">
                    <div class="flex items-center gap-2 pb-2 border-b border-gold-100">
                        <svg class="w-5 h-5 text-gold-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                            </path>
                        </svg>
                        <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest">Portfolio Setup</h3>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-1">
                            <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Horizon
                                (Years)</label>
                            <input type="number" id="inp-years" value="30"
                                class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-700 text-sm focus:outline-none focus:border-gold-400 focus:ring-1 focus:ring-gold-400 transition shadow-sm">
                        </div>
                        <div class="col-span-1">
                            <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Cash Buffer
                                (‚Ç¨)</label>
                            <input type="number" id="inp-buffer" value="0"
                                class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-700 text-sm focus:outline-none focus:border-gold-400 focus:ring-1 focus:ring-gold-400 transition shadow-sm">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Invested Amount
                            (‚Ç¨)</label>
                        <div class="relative">
                            <span class="absolute left-3 top-2 text-slate-400">‚Ç¨</span>
                            <input type="number" id="inp-initial" value="1500000"
                                class="w-full pl-8 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-700 text-sm focus:outline-none focus:border-gold-400 focus:ring-1 focus:ring-gold-400 transition shadow-sm font-mono">
                        </div>
                    </div>

                    <!-- Additional Configs for SWR Logic -->
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Target Annual Exp
                            (‚Ç¨)</label>
                        <div class="relative">
                            <span class="absolute left-3 top-2 text-slate-400">‚Ç¨</span>
                            <input type="number" id="inp-target-annual" value="60000"
                                class="w-full pl-8 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-700 text-sm focus:outline-none focus:border-gold-400 transition shadow-sm font-mono">
                        </div>
                    </div>

                </div>

                <!-- Withdrawal Guardrails (Blue Card Design) -->
                <div class="bg-indigo-50/50 rounded-lg p-3 border border-indigo-100 mt-2">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-[10px] font-bold text-indigo-500 uppercase tracking-widest">Withdrawal
                            Guardrails</span>
                        <svg class="w-3 h-3 text-indigo-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>

                    <div class="space-y-3">
                        <div>
                            <label class="block text-[10px] text-slate-500 mb-1">Floor Multiplier</label>
                            <input type="number" id="inp-floor-mult" value="0.0" step="0.1"
                                class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-slate-700 text-xs">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-[10px] text-slate-500 mb-1">Ceiling (Y1-10)</label>
                                <input type="number" id="inp-ceiling-early" value="100.0" step="0.1"
                                    class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-slate-700 text-xs">
                            </div>
                            <div>
                                <label class="block text-[10px] text-slate-500 mb-1">Ceiling (Y11-50)</label>
                                <input type="number" id="inp-ceiling-late" value="100.0" step="0.1"
                                    class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-slate-700 text-xs">
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Sim Settings -->
                <div class="space-y-4 pt-4 border-t border-gold-100">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-1">
                            <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Sim Data
                                Points</label>
                            <input type="number" id="inp-num-sims" value="1000"
                                class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-700 text-sm focus:outline-none focus:border-gold-400 transition shadow-sm">
                        </div>
                        <div class="col-span-1">
                            <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Target
                                Success</label>
                            <input type="number" step="0.01" id="inp-target-success" value="0.95"
                                class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-slate-700 text-sm focus:outline-none focus:border-gold-400 transition shadow-sm">
                        </div>
                    </div>
                </div>

                <!-- Simulation Button -->
                <div class="pt-2 pb-6">
                    <button id="btn-run" disabled onclick="runSimulation()"
                        class="w-full bg-gradient-to-r from-gold-500 to-amber-500 hover:from-gold-600 hover:to-amber-600 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-4 px-6 rounded-xl shadow-lg shadow-gold-200/50 transition transform active:scale-[0.98] flex justify-center items-center gap-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z">
                            </path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span>Run Simulation</span>
                    </button>
                </div>

                <!-- Asset Allocation -->
                <div class="space-y-4">
                    <div class="flex items-center gap-2 pb-2 border-b border-gold-100">
                        <svg class="w-5 h-5 text-gold-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path>
                        </svg>
                        <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest">Asset Allocation</h3>
                    </div>

                    <div class="bg-gold-50/50 rounded-xl p-4 border border-gold-100 space-y-6">
                        <!-- Bonds (Calculated) -->
                        <div class="pb-2 border-b border-white/50">
                            <div class="flex justify-between text-xs mb-1">
                                <span class="flex items-center gap-1 font-bold text-slate-700">
                                    <span class="text-green-600">‚óè</span> Bonds / Cash
                                </span>
                                <span id="lbl-bonds-pct" class="font-mono text-green-600 font-bold">50%</span>
                            </div>
                            <div class="w-full h-1.5 bg-slate-200 rounded-lg overflow-hidden">
                                <div class="h-full bg-green-200 w-full"></div>
                            </div>
                            <p class="text-[10px] text-slate-400 mt-1">Remainder of portfolio (Safe Bucket)</p>
                        </div>

                        <!-- Stocks Slider -->
                        <div>
                            <div class="flex justify-between text-xs mb-2">
                                <span class="flex items-center gap-1 font-bold text-slate-700">
                                    <span class="text-blue-600">‚óè</span> Stocks (ETF)
                                </span>
                                <span id="lbl-stocks-pct" class="font-mono text-slate-600 font-bold">50%</span>
                            </div>
                            <input type="range"
                                class="w-full accent-blue-600 h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer hover:bg-slate-300 transition"
                                min="0" max="100" step="5" id="inp-alloc-stocks-pct" value="50"
                                oninput="updateAllocations('stocks')">
                        </div>

                        <!-- Crypto Slider -->
                        <div>
                            <div class="flex justify-between text-xs mb-2">
                                <span class="flex items-center gap-1 font-bold text-slate-700">
                                    <span class="text-orange-500">‚óè</span> Crypto (BTC)
                                </span>
                                <span id="lbl-crypto-pct" class="font-mono text-slate-600 font-bold">0%</span>
                            </div>
                            <input type="range"
                                class="w-full accent-orange-500 h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer hover:bg-slate-300 transition"
                                min="0" max="100" step="5" id="inp-alloc-crypto-pct" value="0"
                                oninput="updateAllocations('crypto')">
                        </div>
                    </div>
                </div>

                <!-- Deep Tweak Section -->
                <div class="space-y-4">
                    <button onclick="toggleAdvanced()"
                        class="w-full flex items-center justify-between text-xs font-bold text-gold-600 uppercase tracking-widest hover:text-gold-700 transition outline-none">
                        <span>Advanced Market Assumptions</span>
                        <svg id="icon-advanced" class="w-4 h-4 transform transition-transform" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7">
                            </path>
                        </svg>
                    </button>

                    <div id="pnl-advanced" class="advanced-panel space-y-6">

                        <!-- Stress Test Parameters (New) -->
                        <div class="bg-red-50/50 rounded-lg p-3 border border-red-100">
                            <p class="text-[10px] uppercase font-bold text-red-500 mb-2">Stress Test / Bad Years</p>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-[10px] text-slate-500 mb-1">Max Consecutive Bad Years
                                        (Limit)</label>
                                    <input type="number" id="inp-max-bad-years" value="5"
                                        class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-xs">
                                    <p class="text-[9px] text-slate-400 mt-0.5">Limits recovery logic after this many
                                        down years.</p>
                                </div>

                                <div class="flex items-center gap-2 pt-1 border-t border-red-100/50">
                                    <input type="checkbox" id="chk-force-start-crash"
                                        class="w-3 h-3 accent-red-500 rounded border-gray-300 focus:ring-red-500">
                                    <label for="chk-force-start-crash"
                                        class="text-[10px] font-bold text-red-600 select-none cursor-pointer">Force
                                        Crash at Start</label>
                                </div>

                                <div id="div-crash-config" class="hidden pl-5 space-y-2 border-l-2 border-red-100">
                                    <div>
                                        <label class="block text-[10px] text-slate-500 mb-1">Crash Duration
                                            (Years)</label>
                                        <input type="number" id="inp-crash-duration" value="3"
                                            class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-xs">
                                    </div>
                                    <p class="text-[9px] text-red-400 italic">Forces returns to be negative for the
                                        first N years.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Inflation -->
                        <div class="bg-slate-50 rounded-lg p-3 border border-slate-200">
                            <p class="text-[10px] uppercase font-bold text-slate-400 mb-2">Inflation Parameters</p>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-[10px] text-slate-500 mb-1">Mean Inflation</label>
                                    <input type="number" step="0.001" id="inp-infl-mean" value="0.025"
                                        class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-xs">
                                </div>
                                <div>
                                    <label class="block text-[10px] text-slate-500 mb-1">Vol Inflation</label>
                                    <input type="number" step="0.001" id="inp-infl-vol" value="0.015"
                                        class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-xs">
                                </div>
                            </div>
                        </div>

                        <!-- Correlation -->
                        <div class="bg-slate-50 rounded-lg p-3 border border-slate-200">
                            <p class="text-[10px] uppercase font-bold text-slate-400 mb-2">Asset Correlation</p>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-[10px] text-slate-500 mb-1">Start Correlation</label>
                                    <input type="number" step="0.05" id="inp-corr-start" value="0.40"
                                        class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-xs">
                                </div>
                                <div>
                                    <label class="block text-[10px] text-slate-500 mb-1">End Correlation</label>
                                    <input type="number" step="0.05" id="inp-corr-end" value="0.70"
                                        class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-xs">
                                </div>
                            </div>
                        </div>

                        <!-- Crypto Params -->
                        <div class="bg-orange-50/50 rounded-lg p-3 border border-orange-100">
                            <p class="text-[10px] uppercase font-bold text-orange-400 mb-2">Crypto Assumptions</p>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div>
                                    <label class="block text-[10px] text-slate-500 mb-1">CAGR Start</label>
                                    <input type="number" step="0.01" id="inp-c-cagr-start" value="0.32"
                                        class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-xs font-mono text-orange-600">
                                </div>
                                <div>
                                    <label class="block text-[10px] text-slate-500 mb-1">CAGR End</label>
                                    <input type="number" step="0.01" id="inp-c-cagr-end" value="0.08"
                                        class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-xs font-mono text-orange-600">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-[10px] text-slate-500 mb-1">Vol Start</label>
                                    <input type="number" step="0.01" id="inp-c-vol-start" value="0.40"
                                        class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-xs font-mono text-orange-600">
                                </div>
                                <div>
                                    <label class="block text-[10px] text-slate-500 mb-1">Vol End</label>
                                    <input type="number" step="0.01" id="inp-c-vol-end" value="0.20"
                                        class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-xs font-mono text-orange-600">
                                </div>
                            </div>
                        </div>

                        <!-- Stock Params -->
                        <div class="bg-blue-50/50 rounded-lg p-3 border border-blue-100">
                            <p class="text-[10px] uppercase font-bold text-blue-400 mb-2">Stock Assumptions</p>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div>
                                    <label class="block text-[10px] text-slate-500 mb-1">CAGR Start</label>
                                    <input type="number" step="0.01" id="inp-s-cagr-start" value="0.08"
                                        class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-xs font-mono text-blue-600">
                                </div>
                                <div>
                                    <label class="block text-[10px] text-slate-500 mb-1">CAGR End</label>
                                    <input type="number" step="0.01" id="inp-s-cagr-end" value="0.08"
                                        class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-xs font-mono text-blue-600">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-[10px] text-slate-500 mb-1">Vol Start</label>
                                    <input type="number" step="0.01" id="inp-s-vol-start" value="0.16"
                                        class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-xs font-mono text-blue-600">
                                </div>
                                <div>
                                    <label class="block text-[10px] text-slate-500 mb-1">Vol End</label>
                                    <input type="number" step="0.01" id="inp-s-vol-end" value="0.16"
                                        class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-xs font-mono text-blue-600">
                                </div>
                            </div>
                        </div>

                        <!-- Bond Params -->
                        <div class="bg-green-50/50 rounded-lg p-3 border border-green-100">
                            <p class="text-[10px] uppercase font-bold text-green-400 mb-2">Bond Assumptions</p>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div>
                                    <label class="block text-[10px] text-slate-500 mb-1">CAGR</label>
                                    <input type="number" step="0.001" id="inp-b-cagr-start" value="0.050"
                                        class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-xs font-mono text-green-600">
                                </div>
                                <div>
                                    <label class="block text-[10px] text-slate-500 mb-1">Vol</label>
                                    <input type="number" step="0.01" id="inp-b-vol-start" value="0.05"
                                        class="w-full bg-white border border-slate-200 rounded px-2 py-1 text-xs font-mono text-green-600">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


            </div>
        </aside>

        <!-- Main Content: Results -->
        <main class="flex-1 bg-slate-50 p-10 relative">

            <!-- Welcome / Empty State -->
            <div id="results-placeholder" class="text-center mt-32 opacity-40">
                <div
                    class="w-24 h-24 bg-white rounded-full mx-auto flex items-center justify-center shadow-sm border border-gold-100 mb-6">
                    <svg class="w-10 h-10 text-gold-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                        </path>
                    </svg>
                </div>
                <h2 class="text-3xl font-serif text-slate-700 mb-2">Ready to Simulate</h2>
                <p class="text-slate-500">Configure your portfolio parameters on the left to begin.</p>
            </div>

            <!-- Results Container (Hidden initially) -->
            <div id="results-container" class="hidden space-y-16 max-w-6xl ml-0 mr-auto animate-fade-in pb-20">

                <!-- SECTION 1: THE VISION (Required For Goal) -->
                <div class="space-y-6">
                    <div class="flex items-center gap-4">
                        <h2 class="text-xs font-black text-gold-500 uppercase tracking-[0.2em] whitespace-nowrap">The
                            Vision (Required For Target Goal)</h2>
                        <div class="h-px bg-gold-200 flex-1"></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <!-- Success Probability -->
                        <div
                            class="bg-white rounded-3xl p-8 shadow-sm border border-slate-100 relative overflow-hidden group">
                            <div
                                class="absolute -right-6 -top-6 w-32 h-32 bg-blue-50/50 rounded-full group-hover:scale-110 transition-transform">
                            </div>
                            <p class="text-[10px] font-bold text-blue-500 uppercase tracking-widest relative z-10 mb-2">
                                Success Probability</p>
                            <p id="res-success-val"
                                class="text-7xl font-serif font-bold text-slate-800 text-right relative z-10">--%</p>
                            <div class="w-full bg-slate-100 rounded-full h-2.5 mt-6 relative z-10 overflow-hidden">
                                <div id="res-success-bar"
                                    class="bg-blue-500 h-full rounded-full shadow-[0_0_15px_rgba(59,130,246,0.3)] transition-all duration-1000"
                                    style="width: 0%"></div>
                            </div>
                            <p class="text-[10px] text-slate-400 font-medium mt-5 leading-relaxed">Percentage of
                                scenarios where your capital survived the full term.</p>
                        </div>

                        <!-- Required Capital -->
                        <div
                            class="md:col-span-2 bg-slate-800 rounded-3xl p-8 shadow-xl relative overflow-hidden group">
                            <div
                                class="absolute -right-16 -top-16 w-64 h-64 bg-gold-500/10 rounded-full group-hover:scale-110 transition-transform duration-1000">
                            </div>
                            <div
                                class="flex flex-col md:flex-row md:items-center justify-between h-full relative z-10 gap-8">
                                <div class="space-y-2">
                                    <p class="text-[10px] font-bold text-gold-400 uppercase tracking-[0.2em]">Required
                                        Capital (Goal)</p>
                                    <p id="res-required-capital" class="text-6xl font-serif font-bold text-white">--</p>
                                    <p class="text-[10px] text-slate-400 font-medium italic">Amount needed to achieve
                                        your target success probability.</p>
                                </div>
                                <div
                                    class="bg-slate-700/50 p-6 rounded-2xl border border-slate-600 min-w-[200px] flex flex-col justify-center items-center">
                                    <p id="lbl-shortfall"
                                        class="text-[13px] text-gold-400 font-black uppercase tracking-widest text-center">
                                        --</p>
                                    <p
                                        class="text-[9px] text-slate-400 mt-2 uppercase font-bold text-center tracking-tighter">
                                        Current Funding Gap</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECTION 2: THE REALITY (Possible Today) -->
                <div class="space-y-6 pt-4">
                    <div class="flex items-center gap-4">
                        <h2 class="text-xs font-black text-slate-400 uppercase tracking-[0.2em] whitespace-nowrap">The
                            Reality (Supported by Current Wealth)</h2>
                        <div class="h-px bg-slate-200 flex-1"></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Safe Monthly Range (Colspan 2) -->
                        <div
                            class="md:col-span-2 bg-indigo-50/50 p-8 rounded-3xl border border-indigo-100/60 shadow-sm relative overflow-hidden group">
                            <div
                                class="absolute top-0 right-0 w-48 h-48 bg-indigo-100/40 rounded-full -mr-24 -mt-24 group-hover:scale-110 transition-transform duration-700">
                            </div>

                            <div class="flex items-center justify-between mb-8 relative z-10">
                                <div>
                                    <p class="text-[10px] uppercase font-bold tracking-[0.2em] text-indigo-500 mb-1">
                                        Safe Monthly Budget</p>
                                    <h3 class="text-xl font-serif font-bold text-slate-800">Risk Profile Categories</h3>
                                </div>
                                <span
                                    class="text-[10px] bg-indigo-600 text-white px-4 py-1.5 rounded-full font-bold shadow-sm whitespace-nowrap">Boom
                                    Peak: <span id="res-max-monthly">--</span> ‚Ç¨</span>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-10 relative z-10">
                                <div class="space-y-2 border-r border-indigo-200/50 pr-4">
                                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-tight">
                                        Conservative (99%)</p>
                                    <p id="res-safe-99" class="text-3xl font-serif font-bold text-slate-700">-- ‚Ç¨</p>
                                    <p class="text-[10px] text-slate-400 font-medium italic">Ultra-safe baseline</p>
                                </div>
                                <div class="space-y-2 border-r border-indigo-200/50 pr-4">
                                    <p class="text-[10px] text-indigo-600 font-bold uppercase tracking-tight">Your
                                        Target (<span id="res-target-ptr">--</span>%)</p>
                                    <p id="res-safe-monthly"
                                        class="text-4xl font-serif font-bold text-slate-900 leading-tight">-- ‚Ç¨</p>
                                    <p class="text-[10px] text-indigo-500 font-bold italic">Recommended Safe Rate</p>
                                </div>
                                <div class="space-y-2">
                                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-tight">Aggressive
                                        (90%)</p>
                                    <p id="res-safe-90" class="text-3xl font-serif font-bold text-slate-700">-- ‚Ç¨</p>
                                    <p class="text-[10px] text-slate-400 font-medium italic">Higher lifestyle risk</p>
                                </div>
                            </div>

                            <div
                                class="mt-8 pt-5 border-t border-indigo-200/40 flex justify-between items-center relative z-10">
                                <span class="text-[11px] text-slate-400 font-medium">Desired Lifestyle: <span
                                        id="lbl-target-monthly" class="font-bold text-slate-600">--</span> /mo</span>
                                <span class="text-[9px] text-indigo-400 uppercase font-black opacity-40">Capital
                                    Dependent Realization</span>
                            </div>
                        </div>

                        <!-- SWR Efficiency -->
                        <div
                            class="bg-white rounded-3xl p-8 shadow-sm border border-slate-100 flex flex-col justify-between group overflow-hidden relative">
                            <div
                                class="absolute -right-6 -top-6 w-24 h-24 bg-gold-50 rounded-full opacity-60 group-hover:scale-125 transition-transform duration-500">
                            </div>
                            <div>
                                <p
                                    class="text-[10px] font-bold text-gold-600 uppercase tracking-widest relative z-10 mb-2">
                                    Safe Withdrawal Rate</p>
                                <p id="res-swr-val"
                                    class="text-6xl font-serif font-bold text-slate-800 text-right relative z-10">--%
                                </p>
                            </div>
                            <p
                                class="text-[10px] text-slate-400 font-medium mt-4 relative z-10 border-t border-slate-50 pt-4 leading-relaxed">
                                <span class="block font-bold text-slate-600 mb-1">Portfolio Efficiency</span>
                                <span id="res-target-disp-desc" class="italic text-gold-600/70">Optimized for your
                                    survival odds</span>
                            </p>
                        </div>
                    </div>

                    <!-- Row 2: Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Median Outcome -->
                        <div
                            class="bg-white rounded-3xl p-8 shadow-sm border border-slate-100 relative overflow-hidden group flex items-center justify-between">
                            <div
                                class="absolute -right-6 -top-6 w-24 h-24 bg-purple-50 rounded-full opacity-50 group-hover:scale-110 transition-transform">
                            </div>
                            <div class="relative z-10">
                                <p class="text-[10px] font-bold text-purple-500 uppercase tracking-widest mb-1">Median
                                    Projected Wealth</p>
                                <div class="flex items-baseline gap-1">
                                    <p id="res-median-end" class="text-4xl font-serif font-bold text-slate-900">--</p>
                                    <span class="text-xs text-slate-400 font-bold uppercase">Million ‚Ç¨</span>
                                </div>
                                <p class="text-[9px] text-purple-400 mt-2 font-medium">Outcome in 50% of simulated
                                    futures.</p>
                            </div>
                        </div>

                        <!-- Worst Case -->
                        <div
                            class="bg-white rounded-3xl p-8 shadow-sm border border-slate-100 relative overflow-hidden group flex items-center justify-between">
                            <div
                                class="absolute -right-6 -top-6 w-24 h-24 bg-red-50 rounded-full opacity-50 group-hover:scale-110 transition-transform">
                            </div>
                            <div class="relative z-10">
                                <p class="text-[10px] font-bold text-red-500 uppercase tracking-widest mb-1">1% Worst
                                    Case Margin</p>
                                <div class="flex items-baseline gap-1">
                                    <p id="res-worst-case" class="text-4xl font-serif font-bold text-slate-900">--</p>
                                </div>
                                <p class="text-[9px] text-red-400 mt-2 font-medium">Statistical "Zero Bound" for capital
                                    safety.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Chart -->
                    <div class="bg-white rounded-3xl p-8 shadow-sm border border-slate-100">
                        <div id="plot-area"
                            class="w-full flex justify-center items-center bg-slate-50 rounded-2xl p-4 min-h-[300px]">
                            <span class="text-slate-400 text-sm">Chart will render here...</span>
                        </div>
                    </div>
                </div>

            </div>

        </main>
    </div>

    <!-- VIEW: INFO / METHODOLOGY -->
    <div id="view-info" class="hidden flex-1 overflow-y-auto bg-white p-10 animate-fade-in">
        <div class="max-w-4xl mx-auto space-y-8">
            <h2 class="text-4xl font-serif font-bold text-slate-800 text-right border-b border-gold-200 pb-4">
                Methodology & Glossary</h2>
            <section class="space-y-4">
                <h3 class="text-2xl font-serif text-gold-600">Core Logic: Monte Carlo Simulation</h3>
                <p class="text-slate-600 leading-relaxed">
                    This calculator uses <strong>Monte Carlo Simulation</strong> to generate thousands of possible
                    future market scenarios
                    based on statistical parameters.
                    This allows us to stress-test your portfolio against millions of potential realities, including
                    those worse than history.
                </p>
            </section>
            <section class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-slate-50 p-6 rounded-xl border border-slate-100">
                    <h4 class="font-bold text-slate-700 mb-2">CAGR (Compound Annual Growth Rate)</h4>
                    <p class="text-sm text-slate-500">The mean annual return.</p>
                </div>
                <div class="bg-slate-50 p-6 rounded-xl border border-slate-100">
                    <h4 class="font-bold text-slate-700 mb-2">Volatility (Risk)</h4>
                    <p class="text-sm text-slate-500">Standard deviation of returns. We use a "Skewed Normal"
                        distribution.</p>
                </div>
                <div class="bg-slate-50 p-6 rounded-xl border border-slate-100">
                    <h4 class="font-bold text-slate-700 mb-2">Gaussian Copula (Correlation)</h4>
                    <p class="text-sm text-slate-500">Mathematical method to link the random movements of Stocks and
                        Crypto.</p>
                </div>
                <div class="bg-slate-50 p-6 rounded-xl border border-slate-100">
                    <h4 class="font-bold text-slate-700 mb-2">Safe Withdrawal Rate (SWR)</h4>
                    <p class="text-sm text-slate-500">The percentage of your portfolio you can withdraw annually without
                        depleting it.</p>
                </div>
            </section>
        </div>

        <!-- CALCULATION LOGIC SECTION -->
        <div class="max-w-4xl mx-auto space-y-8 mt-16 pt-16 border-t border-slate-100">
            <h3 class="text-2xl font-serif font-bold text-slate-800">Calculation Logic Explained</h3>

            <div class="bg-slate-900 rounded-xl p-6 overflow-hidden text-sm font-mono text-slate-300">
                <div class="flex items-center gap-2 mb-4 text-green-400 border-b border-slate-700 pb-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                    </svg>
                    <span>Portfolio Simulation Loop (Code Excerpt)</span>
                </div>
                <pre>
<span class="text-purple-400">for</span> (let y = 0; y < years; y++) {
    <span class="text-slate-500">// 1. Determine Spending Limits (Guardrails)</span>
    <span class="text-blue-300">const</span> withdrawal = Math.min(
        Math.max(currentTarget, currentFloor), <span class="text-slate-500">// Floor Protection</span>
        currentCeiling                         <span class="text-slate-500">// Ceiling Cap</span>
    );

    <span class="text-slate-500">// 2. Cash Buffer Protection (Sequence Risk Shield)</span>
    <span class="text-purple-400">if</span> (marketReturn < 0) {
        <span class="text-slate-500">// MARKET DOWN: "Prime Harvesting"</span>
        <span class="text-slate-500">// We spend Cash first to avoid selling depreciated assets.</span>
        cashDraw = Math.min(withdrawal, cash);
    } <span class="text-purple-400">else</span> {
        <span class="text-slate-500">// MARKET UP: Spend from Portfolio Gains</span>
        cashDraw = 0;
    }
}
</pre>
            </div>

            <section class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="p-4 border-l-2 border-gold-400">
                    <h4 class="font-bold text-slate-700">Volatility (The Risk)</h4>
                    <p class="text-sm text-slate-500 mt-2">We use <strong>Skew Normal Distributions</strong> to model
                        "Fat Tails" (Crashes). Standard Bell Curves underestimate how often the market drops -20% or
                        more.</p>
                </div>
                <div class="p-4 border-l-2 border-green-400">
                    <h4 class="font-bold text-slate-700">Cash Buffer (The Shield)</h4>
                    <p class="text-sm text-slate-500 mt-2">When the market is down (Negative Return), the simulation
                        automatically draws from your Cash Buffer instead of selling stocks. This drastically improves
                        survival odds.</p>
                </div>
                <div class="p-4 border-l-2 border-blue-400">
                    <h4 class="font-bold text-slate-700">Guardrails (The Brakes)</h4>
                    <p class="text-sm text-slate-500 mt-2">If inflation spikes, your "Ceiling" prevents you from
                        overspending. If your portfolio crashes, the "Floor" ensures you still have enough for basics.
                    </p>
                </div>
            </section>
        </div>

    </div>

    <!-- VIEW: SATOSHI NAKAMOTO -->
    <div id="view-satoshi" class="hidden flex-1 overflow-y-auto bg-gold-50 p-10 animate-fade-in">
        <article
            class="max-w-3xl mx-auto bg-white shadow-xl shadow-gold-100/50 p-12 rounded-lg border border-gold-100 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-gold-400 to-gold-600"></div>

            <header class="mb-10 text-center">
                <span class="text-xs font-bold tracking-[0.2em] text-gold-600 uppercase">The Origin</span>
                <h1 class="text-5xl font-serif font-bold text-slate-900 mt-4 mb-6">Who is Satoshi Nakamoto?</h1>
            </header>
            <div class="prose prose-slate prose-lg mx-auto text-slate-600 font-serif leading-loose">
                <p>
                    <span class="text-6xl float-left mr-4 mt-[-10px] font-bold text-gold-500">O</span>n October 31,
                    2008, a link to a paper titled
                    <em>"Bitcoin: A Peer-to-Peer Electronic Cash System"</em> was posted to a cryptography mailing list.
                    The author was <strong>Satoshi Nakamoto</strong>.
                </p>
                <p>
                    Satoshi didn't just write code; he architected a solution to the "Double-Spend Problem" without
                    requiring a central authority.
                </p>
                <blockquote
                    class="border-l-4 border-gold-400 pl-6 italic my-8 text-slate-500 bg-gold-50 py-4 pr-4 rounded-r-lg">
                    "The root problem with conventional currency is all the trust that's required to make it work... the
                    history of fiat currencies is full of breaches of that trust."
                </blockquote>
                <p>
                    In 2011, Satoshi sent a final email stating he had "moved on to other things," and vanished.
                </p>
            </div>
            <div class="mt-12 pt-8 border-t border-slate-100 text-center">
                <p class="text-xs text-slate-400 uppercase tracking-widest font-sans">WealthGuard Simulations ‚Ä¢ Est.
                    2026</p>
            </div>
        </article>
    </div>

    <!-- TUTORIAL OVERLAY -->
    <div id="tutorial-overlay" class="fixed inset-0 hidden z-50 pointer-events-none"></div>

    <!-- NATIVE JS LOGIC -->
    <script>
        // --- VISUALIZATION & UI HELPERS ---
        // Note: The core math is now in 'js/engine.js' and 'js/statistics.js'

        function renderHistogram(data, targetDivId) {
            const div = document.getElementById(targetDivId);
            div.innerHTML = '<canvas id="hist-canvas" class="w-full h-[300px]"></canvas>';
            const canvas = document.getElementById('hist-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;

            const filteredData = data.filter(w => w < 100_000_000).map(w => w / 1e6);
            if (filteredData.length === 0) return;

            const min = 0;
            const max = Math.max(...filteredData);
            const bins = 50;
            const counts = new Array(bins).fill(0);
            filteredData.forEach(val => {
                let b = Math.floor(((val - min) / (max - min)) * bins);
                if (b >= bins) b = bins - 1;
                counts[b]++;
            });

            const maxCount = Math.max(...counts);
            const padding = 40;
            const chartW = canvas.width - 2 * padding;
            const chartH = canvas.height - 2 * padding;

            ctx.strokeStyle = '#e2e8f0'; ctx.lineWidth = 1;
            for (let i = 0; i <= 5; i++) {
                let y = padding + chartH - (i / 5) * chartH;
                ctx.beginPath(); ctx.moveTo(padding, y); ctx.lineTo(padding + chartW, y); ctx.stroke();
            }

            const barW = chartW / bins;
            ctx.fillStyle = '#f7931a';
            ctx.globalAlpha = 0.8;
            counts.forEach((c, i) => {
                const h = (c / maxCount) * chartH;
                ctx.fillRect(padding + i * barW, padding + chartH - h, barW - 1, h);
            });

            ctx.globalAlpha = 1.0; ctx.fillStyle = '#64748b';
            ctx.font = '10px Inter'; ctx.textAlign = 'center';
            for (let i = 0; i <= 5; i++) {
                const val = (min + (max - min) * (i / 5)).toFixed(1);
                ctx.fillText(val + "M", padding + (i / 5) * chartW, canvas.height - 20);
            }
            ctx.fillText("Wealth Distribution (Million ‚Ç¨)", canvas.width / 2, canvas.height - 5);
        }

        const statusEl = document.getElementById("status-indicator");
        const btnRun = document.getElementById("btn-run");
        window.update_status = function (msg, colorClass) {
            statusEl.innerHTML = `<span class="${colorClass}">${msg}</span>`;
        }

        function updateAllocations(source) {
            const cryptoEl = document.getElementById('inp-alloc-crypto-pct');
            const stocksEl = document.getElementById('inp-alloc-stocks-pct');
            const bondsEl = document.getElementById('lbl-bonds-pct'); // New Label

            let cVal = parseInt(cryptoEl.value) || 0;
            let sVal = parseInt(stocksEl.value) || 0;

            // Limit logic: If sum > 100, reduce the *other* one
            if (cVal + sVal > 100) {
                if (source === 'crypto') {
                    sVal = 100 - cVal;
                    stocksEl.value = sVal;
                } else {
                    cVal = 100 - sVal;
                    cryptoEl.value = cVal;
                }
            }

            const bVal = 100 - cVal - sVal;

            document.getElementById('lbl-crypto-pct').innerText = cVal + "%";
            document.getElementById('lbl-stocks-pct').innerText = sVal + "%";

            if (bondsEl) {
                bondsEl.innerText = bVal + "%";
                // Visual feedback if bonds are low
                bondsEl.className = bVal < 20 ? "font-mono font-bold text-red-500" : "font-mono font-bold text-green-600";
            }
        }

        function toggleAdvanced() {
            const panel = document.getElementById('pnl-advanced');
            const icon = document.getElementById('icon-advanced');
            panel.classList.toggle('open');
            icon.style.transform = panel.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0deg)';
        }

        document.getElementById('chk-force-start-crash').addEventListener('change', (e) => {
            document.getElementById('div-crash-config').classList.toggle('hidden', !e.target.checked);
        });

        async function runSimulation() {
            btnRun.disabled = true;
            btnRun.innerHTML = '<div class="loading-spinner"></div><span>Simulating...</span>';

            // Allow UI to update
            await new Promise(r => setTimeout(r, 50));

            try {
                const configs = {
                    years: parseInt(document.getElementById("inp-years").value),
                    numSims: parseInt(document.getElementById("inp-num-sims").value),
                    INVESTED_AMOUNT: parseFloat(document.getElementById("inp-initial").value) - parseFloat(document.getElementById("inp-buffer").value),
                    CASH_BUFFER: parseFloat(document.getElementById("inp-buffer").value),
                    ALLOC_CRYPTO: parseFloat(document.getElementById("inp-alloc-crypto-pct").value) / 100,
                    ALLOC_STOCKS: parseFloat(document.getElementById("inp-alloc-stocks-pct").value) / 100,
                    INFL_MEAN: parseFloat(document.getElementById("inp-infl-mean").value),
                    INFL_VOL: parseFloat(document.getElementById("inp-infl-vol").value),
                    CORR_START: parseFloat(document.getElementById("inp-corr-start").value),
                    CORR_END: parseFloat(document.getElementById("inp-corr-end").value),
                    C_CAGR_START: parseFloat(document.getElementById("inp-c-cagr-start").value),
                    C_CAGR_END: parseFloat(document.getElementById("inp-c-cagr-end").value),
                    C_VOL_START: parseFloat(document.getElementById("inp-c-vol-start").value),
                    C_VOL_END: parseFloat(document.getElementById("inp-c-vol-end").value),
                    S_CAGR_START: parseFloat(document.getElementById("inp-s-cagr-start").value),
                    S_CAGR_END: parseFloat(document.getElementById("inp-s-cagr-end").value),
                    S_VOL_START: parseFloat(document.getElementById("inp-s-vol-start").value),
                    S_VOL_END: parseFloat(document.getElementById("inp-s-vol-end").value),
                    B_CAGR_START: parseFloat(document.getElementById("inp-b-cagr-start").value),
                    B_VOL_START: parseFloat(document.getElementById("inp-b-vol-start").value),
                    FORCE_CRASH: document.getElementById("chk-force-start-crash").checked,
                    CRASH_DURATION: parseInt(document.getElementById("inp-crash-duration").value),
                    TARGET_ANNUAL_EXP: parseFloat(document.getElementById("inp-target-annual").value),
                    FLOOR_MULT: parseFloat(document.getElementById("inp-floor-mult").value),
                    CEILING_EARLY: parseFloat(document.getElementById("inp-ceiling-early").value),
                    CEILING_LATE: parseFloat(document.getElementById("inp-ceiling-late").value),
                    CEILING_LATE: parseFloat(document.getElementById("inp-ceiling-late").value),
                    targetSuccess: (() => {
                        let valStr = document.getElementById("inp-target-success").value.replace(',', '.');
                        let val = parseFloat(valStr);
                        // If user enters "95", treat as 95%. If "0.95", treat as 95%.
                        // Threshold: if > 1, assume percentage (divide by 100).
                        if (val > 1) val /= 100;
                        return val || 0.95; // Default strict 95%
                    })()
                };

                update_status(`Simulating ${configs.numSims} Scenarios...`, "text-gold-600");
                const marketData = generateMarketData(configs.numSims, configs.years, configs);

                update_status("Calculating Risk Profiles...", "text-purple-500");
                const shConfigs = { ...configs, INVESTED_AMOUNT: 1000000, CASH_BUFFER: 0, TARGET_ANNUAL_EXP: 0 };

                const findSWR = (targetOdds) => {
                    let low = 0.001, high = 0.20, best = 0.001;
                    for (let i = 0; i < 15; i++) {
                        let mid = (low + high) / 2;
                        let res = simulatePortfolio(mid, marketData, shConfigs);
                        console.log(`SWR Search: Rate ${(mid * 100).toFixed(2)}% -> Success ${(res.successRate * 100).toFixed(1)}%`);
                        if (res.successRate >= targetOdds) { best = mid; low = mid; }
                        else { high = mid; }
                    }
                    return best;
                };

                const bestSWR = findSWR(configs.targetSuccess);
                const swr99 = findSWR(0.99);
                const swr90 = findSWR(0.90);

                update_status("Final Verification...", "text-indigo-500");
                // Final run
                const final = simulatePortfolio(-1, marketData, configs); // -1 withdrawal uses TargetAnnual

                // Update UI
                document.getElementById("res-swr-val").innerText = (bestSWR * 100).toFixed(2) + "%";
                document.getElementById("res-success-val").innerText = (final.successRate * 100).toFixed(1) + "%";
                document.getElementById("res-success-bar").style.width = (final.successRate * 100) + "%";

                // Advanced UI Fields
                document.getElementById("res-target-disp-desc").innerText = `Optimized for ${(configs.targetSuccess * 100).toFixed(0)}% survival odds`;
                document.getElementById("res-target-ptr").innerText = (configs.targetSuccess * 100).toFixed(0);

                const wealths = final.wealths.sort((a, b) => a - b);
                const median = wealths[Math.floor(wealths.length / 2)];
                const worst1 = wealths[Math.floor(wealths.length * 0.01)];

                document.getElementById("res-median-end").innerText = (median / 1e6).toLocaleString(undefined, { minimumFractionDigits: 2 });
                document.getElementById("res-worst-case").innerText = (worst1 / 1e6).toLocaleString(undefined, { minimumFractionDigits: 2 }) + " M ‚Ç¨";

                const reqCap = configs.TARGET_ANNUAL_EXP / bestSWR;
                const initialTotal = configs.INVESTED_AMOUNT + configs.CASH_BUFFER;
                const shortfall = Math.max(0, reqCap - initialTotal);

                document.getElementById("res-required-capital").innerText = (reqCap / 1e6).toFixed(2) + " M ‚Ç¨";

                const goalText = shortfall <= 0 ? "Goal Reached" : `Goal distance: ${(shortfall / 1e6).toFixed(2)} M ‚Ç¨`;
                document.getElementById("lbl-shortfall").innerText = goalText;

                // Monthly Reality
                const targetMonthly = configs.TARGET_ANNUAL_EXP / 12;
                const safeMonthly = (initialTotal * bestSWR) / 12;
                const m99 = (initialTotal * swr99) / 12;
                const m90 = (initialTotal * swr90) / 12;
                let peakMonthly = targetMonthly * configs.CEILING_LATE;
                if (targetMonthly === 0) peakMonthly = safeMonthly;

                document.getElementById("res-safe-monthly").innerText = safeMonthly.toLocaleString(undefined, { maximumFractionDigits: 0 }) + " ‚Ç¨";
                document.getElementById("res-safe-99").innerText = m99.toLocaleString(undefined, { maximumFractionDigits: 0 }) + " ‚Ç¨";
                document.getElementById("res-safe-90").innerText = m90.toLocaleString(undefined, { maximumFractionDigits: 0 }) + " ‚Ç¨";
                document.getElementById("res-max-monthly").innerText = peakMonthly.toLocaleString(undefined, { maximumFractionDigits: 0 });
                document.getElementById("lbl-target-monthly").innerText = targetMonthly.toLocaleString(undefined, { maximumFractionDigits: 0 }) + " ‚Ç¨";

                renderHistogram(final.wealths, "plot-area");

                document.getElementById("results-placeholder").classList.add("hidden");
                document.getElementById("results-container").classList.remove("hidden");
                window.scrollTo({ top: 0, behavior: 'smooth' });
                update_status("Simulation Complete", "text-green-600");

            } catch (e) {
                console.error(e);
                alert("Error: " + e.message);
                update_status("Error", "text-red-600");
            } finally {
                btnRun.disabled = false;
                btnRun.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span>Run Simulation</span>`;
            }
        }


        // --- NAVIGATION LOGIC ---
        function switchView(viewName) {
            ['calculator', 'info', 'satoshi'].forEach(v => {
                const el = document.getElementById('view-' + v);
                const nav = document.getElementById('nav-' + v);
                if (el) el.classList.add('hidden');
                if (nav) nav.classList.remove('active', 'text-gold-600');
            });

            const targetEl = document.getElementById('view-' + viewName);
            const targetNav = document.getElementById('nav-' + viewName);
            if (targetEl) targetEl.classList.remove('hidden');
            if (targetNav) targetNav.classList.add('active', 'text-gold-600');
        }

        // --- TUTORIAL LOGIC ---
        const tutorialSteps = [
            { id: 'inp-years', title: 'Time Horizon', text: 'How long do you want to plan for?' },
            { id: 'inp-initial', title: 'Invested Capital', text: 'Your current starting portfolio value.' },
            { id: 'inp-buffer', title: 'Cash Buffer', text: 'Cash set aside for emergencies.' },
            { id: 'inp-alloc-crypto-pct', title: 'Asset Allocation', text: 'Balance between Crypto and Stocks.' },
            { id: 'btn-run', title: 'Run Simulation', text: 'Starts the JS Monte Carlo engine.' }
        ];

        let currentStepIndex = -1;

        function startTutorial() {
            switchView('calculator');
            currentStepIndex = 0;
            const ov = document.getElementById('tutorial-overlay');
            ov.classList.remove('hidden', 'pointer-events-none');
            showTutorialStep();
        }

        function endTutorial() {
            currentStepIndex = -1;
            const ov = document.getElementById('tutorial-overlay');
            ov.classList.add('hidden', 'pointer-events-none');
            ov.innerHTML = '';
        }

        function showTutorialStep() {
            const step = tutorialSteps[currentStepIndex];
            const el = document.getElementById(step.targetOverride || step.id);
            if (!el) { endTutorial(); return; }

            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            const rect = el.getBoundingClientRect();

            // Simple positioning
            let top = rect.bottom + window.scrollY + 12;
            let left = rect.left + window.scrollX;

            const tooltipHtml = `
            <div class="tutorial-tooltip tooltip-bottom" style="top: ${top}px; left: ${left}px;">
                <div class="flex justify-between items-start mb-2 border-b border-white/20 pb-2">
                    <h4 class="font-bold text-white text-sm">${step.title}</h4>
                </div>
                <p class="text-sm text-white/90 mb-4">${step.text}</p>
                <div class="flex gap-2">
                    <button onclick="endTutorial()" class="text-xs text-white/60 hover:text-white">Skip</button>
                    <button onclick="nextStep()" class="bg-white/20 text-white text-xs font-bold px-4 py-1.5 rounded">Next</button>
                </div>
            </div>`;
            document.getElementById('tutorial-overlay').innerHTML = tooltipHtml;
        }

        function nextStep() {
            currentStepIndex++;
            if (currentStepIndex >= tutorialSteps.length) endTutorial();
            else showTutorialStep();
        }

        // Initialize logic
        (function main() {
            update_status("Engine Ready", "text-gold-700");
            const btn = document.getElementById("btn-run");
            if (btn) btn.disabled = false;

            // Fake loading animation
            const spinner = document.getElementById('main-spinner');
            const rocket = document.getElementById('rocket-anim');
            const overlay = document.getElementById('loading-overlay');

            if (spinner) spinner.style.display = 'none';

            setTimeout(() => {
                if (rocket) rocket.classList.add('launch');
                setTimeout(() => {
                    if (overlay) overlay.classList.add('fade-out');
                }, 400);
            }, 600);
        })();

    </script>

</body>

</html>